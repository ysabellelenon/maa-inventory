{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/suppliers.css' %}">
{% endblock %}

{% block content %}
  {% if messages %}
    <div style="margin-bottom: 20px;">
      {% for message in messages %}
        <div style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; background: {% if message.tags == 'error' %}#fee2e2{% elif message.tags == 'success' %}#dcfce7{% else %}var(--accent){% endif %}; color: {% if message.tags == 'error' %}#991b1b{% elif message.tags == 'success' %}#166534{% else %}var(--text){% endif %}; border: 1px solid {% if message.tags == 'error' %}#fecaca{% elif message.tags == 'success' %}#bbf7d0{% else %}var(--border){% endif %};">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
  
  <div class="page-header inventory-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Suppliers</h2>
    <div style="display: flex; gap: 12px;">
      {% if is_procurement %}
      <button id="add-price-discussion-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--focus); color: white; border: 1px solid var(--focus); border-radius: 8px; font-weight: 500; cursor: pointer; transition: background 0.2s;">
        <img src="{% static 'icons/plus.svg' %}" alt="Add" style="width: 16px; height: 16px; filter: brightness(0) invert(1);" />
        Add Price Discussion
      </button>
      <a href="{% url 'add_supplier' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--focus); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.2s; border: 1px solid var(--focus);">
        <img src="{% static 'icons/plus.svg' %}" alt="Add" style="width: 16px; height: 16px; filter: brightness(0) invert(1);" />
        Add Supplier
      </a>
      {% endif %}
    </div>
  </div>

  <div class="inventory-container">
    <div class="inventory-card">
      <div class="table-actions">
        <div class="table-actions-left">
          <div class="table-search">
            <img src="{% static 'icons/search.svg' %}" class="table-search-icon" alt="Search" />
            <input class="table-search-input" placeholder="Search by requestor or item" aria-label="Search requests" />
          </div>
          <button class="btn-filter">
            <img src="{% static 'icons/filter.svg' %}" alt="" />
            <span>Filter</span>
          </button>
        </div>
      </div>
      <div class="table-wrapper">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" class="select-all" aria-label="Select all suppliers" /></th>
            <th class="col-expand"></th>
            <th class="col-code">Supplier Code</th>
            <th class="col-name">Supplier Name</th>
            <th class="col-category">Category</th>
            <th class="col-contact">Contact Person</th>
            <th class="col-phone">Phone</th>
            <th class="col-email">Email</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="inventory-row" style="cursor: pointer;" onclick="window.location.href='{% url 'edit_supplier' item.id %}'" onmouseover="this.style.backgroundColor='#F9FAFB'" onmouseout="this.style.backgroundColor=''">
              <td class="col-check" onclick="event.stopPropagation();"><input type="checkbox" class="row-select" aria-label="select supplier #{{ forloop.counter }}" /></td>
              <td class="col-expand" onclick="event.stopPropagation();">
                <button class="expand" aria-hidden="true">
                  <img class="expand-icon" src="{% static 'icons/chevron-right.svg' %}" alt="" />
                </button>
              </td>
              <td class="col-code">{{ item.code }}</td>
              <td class="col-name">
                <div class="item-meta">
                  <div class="item-title">{{ item.name }}</div>
                </div>
              </td>
              <td class="col-category" onclick="event.stopPropagation();">
                <select class="category-dropdown" data-supplier-id="{{ item.id }}" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; font-family: var(--font-stack); font-size: 13px; background: var(--card-bg); color: var(--text);">
                  <option value="">—</option>
                  {% for category in categories %}
                    <option value="{{ category.id }}" {% if item.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="col-contact">{{ item.contact_person|default:"—" }}</td>
              <td class="col-phone">{{ item.phone|default:"—" }}</td>
              <td class="col-email">{{ item.email|default:"—" }}</td>
              <td class="col-action" onclick="event.stopPropagation();">
                <div class="action-btn-container">
                  <button class="action-btn" aria-label="More actions"
                          data-code="{{ item.code|default:forloop.counter }}"
                          data-name="{{ item.name|default:'—' }}"
                          data-supplier="{{ item.name|default:'—' }}"
                          data-image="">
                    <img src="{% static 'icons/more.svg' %}" alt="More" class="action-icon" />
                  </button>
                </div>
              </td>
            </tr>
            <tr class="inventory-details" hidden>
              <td colspan="9">
                <div class="details-inner">
                  <div class="details-header">Details</div>

                  <!-- Top cards row (summary metrics) -->
                  <div class="details-content">
                  <div class="details-cards" role="region" aria-label="Supplier summary">
                    <div class="details-card">
                      <div class="card-label">Total Spend</div>
                      <div class="card-value">{{ item.total_spend|default:"—" }}</div>
                    </div>
                    <div class="details-card card-wide">
                      <div class="card-label">Pending Invoices</div>
                      <div class="card-value">
                        <span class="card-main">{{ item.pending_invoices|default:"—" }}</span>
                        {% if item.pending_invoice_count is not none %}
                          <span class="card-note">({{ item.pending_invoice_count }} invoices)</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="details-card">
                      <div class="card-label">Items Supplied</div>
                      <div class="card-value">
                        {% if item.products_supplied %}
                          {{ item.products_supplied|length }}
                        {% else %}
                          —
                        {% endif %}
                      </div>
                    </div>
                    <div class="details-card">
                      <div class="card-label">Supplier Hold</div>
                      <div class="card-value">
                        <span class="card-main">{{ item.supplier_hold|default:"—" }}</span>
                        <span class="card-note">Items</span>
                      </div>
                    </div>
                    <div class="details-card">
                      <div class="card-label">Active Orders</div>
                      <div class="card-value">{{ item.active_orders|default:"—" }}</div>
                    </div>
                  </div>

                  <!-- Two-column details grid -->
                  <div class="details-grid details-grid-two-col" aria-hidden="false">
                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">Location</div>
                        <div class="detail-value">{{ item.location|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">Delivery Lead Time</div>
                        <div class="detail-value">{{ item.delivery_lead_time|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">Bank Name</div>
                        <div class="detail-value">{{ item.bank_name|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">Bank Account Details</div>
                        <div class="detail-value">{{ item.bank_account_details|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">IBAN Number</div>
                        <div class="detail-value">{{ item.iban_number|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-pair">
                        <div class="detail-label">Last Ordered Date</div>
                        <div class="detail-value">{{ item.last_ordered_date|default:"—" }}</div>
                      </div>
                    </div>

                    <div class="detail-item detail-full">
                      <div class="detail-pair">
                        <div class="detail-label">Products Supplied (Item — Price)</div>
                        <div class="detail-value">
                          {% if item.products_supplied %}
                            <ul class="products-supplied-list">
                              {% for p in item.products_supplied %}
                                <li>{{ p.item_name }} — {{ p.price_per_unit }}</li>
                              {% endfor %}
                            </ul>
                          {% else %}
                            — 
                          {% endif %}
                        </div>
                      </div>
                    </div>

                    <div class="detail-item detail-full">
                      <div class="detail-pair">
                        <div class="detail-label">Notes / Internal Comments</div>
                        <div class="detail-value">{{ item.notes|default:"—" }}</div>
                      </div>
                    </div>

                  </div>
                  </div>

                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      <div class="table-footer">
        <div class="table-footer-left">
          <label class="show-label">Show
            <select class="page-size" aria-label="Results per page">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span class="entries-info">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
          </span>
        </div>
        <div class="table-footer-right">
          {% if page_obj.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="page-prev" aria-label="Previous page">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </a>
            {% else %}
            <span class="page-prev" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </span>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="page-num active" aria-current="page">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == 1 or num == page_obj.paginator.num_pages %}
                <a href="?page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                <span class="page-dots">…</span>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="page-next" aria-label="Next page">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </a>
            {% else %}
            <span class="page-next" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </span>
            {% endif %}
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

<script>
  (function () {
    var rightIcon = "{% static 'icons/chevron-right.svg' %}";
    var downIcon = "{% static 'icons/chevron-down.svg' %}";
    function toggleRow(button) {
      var row = button.closest('tr');
      if (!row) return;
      var details = row.nextElementSibling;
      var img = button.querySelector('img.expand-icon');
      var expanded = row.classList.toggle('expanded');
      if (details && details.classList.contains('inventory-details')) {
        if (expanded) {
          details.removeAttribute('hidden');
        } else {
          details.setAttribute('hidden', '');
        }
      }
      if (img) {
        img.setAttribute('src', expanded ? downIcon : rightIcon);
      }
      // update aria-expanded
      button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }

    document.addEventListener('click', function (e) {
      var btn = e.target.closest && e.target.closest('.expand');
      if (btn) {
        e.preventDefault();
        toggleRow(btn);
      }
    });
  })();
</script>

<!-- Action menu (same behavior as Inventory) -->
<div class="overlay" hidden></div>
<div class="action-menu" hidden role="menu" aria-hidden="true">
  <button class="action-menu-item" data-action="edit">Edit</button>
  <button class="action-menu-item" data-action="delete" style="color: #dc2626;">Delete</button>
</div>

<script>
  (function () {
    var actionMenu = document.querySelector('.action-menu');
    var currentActionButton = null;
    if (!actionMenu) return;

    function showActionMenu(button) {
      currentActionButton = button;
      var rect = button.getBoundingClientRect();
      actionMenu.removeAttribute('hidden');
      actionMenu.setAttribute('aria-hidden', 'false');
      actionMenu.style.left = '-9999px';
      actionMenu.style.top = '-9999px';
      var menuWidth = actionMenu.offsetWidth || 160;
      var left = rect.right + window.scrollX - menuWidth;
      var top = rect.bottom + window.scrollY + 6;
      var minLeft = 8 + window.scrollX;
      if (left < minLeft) left = minLeft;
      actionMenu.style.left = left + 'px';
      actionMenu.style.top = top + 'px';
    }

    function hideActionMenu() {
      if (!actionMenu) return;
      actionMenu.setAttribute('hidden', '');
      actionMenu.setAttribute('aria-hidden', 'true');
      currentActionButton = null;
    }

    // Attach handlers directly to action buttons
    var actionButtons = document.querySelectorAll('.action-btn');
    actionButtons.forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (actionMenu && actionMenu.getAttribute('aria-hidden') === 'false' && currentActionButton === btn) {
          hideActionMenu();
        } else {
          showActionMenu(btn);
        }
      });
    });

    document.addEventListener('click', function (e) {

      var menuItem = e.target.closest && e.target.closest('.action-menu-item');
      if (menuItem && currentActionButton) {
        e.preventDefault();
        var action = menuItem.getAttribute('data-action');
        var btn = currentActionButton;
        var data = {
          code: btn.getAttribute('data-code') || '—',
          name: btn.getAttribute('data-name') || '—',
          supplier: btn.getAttribute('data-supplier') || '—',
          image: btn.getAttribute('data-image') || ''
        };
        hideActionMenu();
        var path = window.location.pathname;
        var base = '/';
        if (path.indexOf('/requests') !== -1) base = '/requests/';
        else if (path.indexOf('/suppliers') !== -1) base = '/suppliers/';
        else base = '/inventory/';

        if (action === 'edit') {
          window.location.href = base + 'edit/' + encodeURIComponent(data.code) + '/';
        } else if (action === 'delete') {
          var supplierName = data.name || data.supplier || 'this supplier';
          if (confirm('Are you sure you want to delete ' + supplierName + '? This action cannot be undone.')) {
            window.location.href = base + 'delete/' + encodeURIComponent(data.code) + '/';
          }
        }
        return;
      }

      if (actionMenu && !e.target.closest('.action-menu')) {
        hideActionMenu();
      }
    });
  })();
</script>

<script>
  (function () {
    var selectAll = document.querySelector('.select-all');
    var table = document.querySelector('.inventory-table');
    if (!selectAll || !table) return;

    function updateSelectAllState() {
      var rowCheckboxes = table.querySelectorAll('tbody input.row-select');
      var total = rowCheckboxes.length;
      var checked = 0;
      rowCheckboxes.forEach(function (cb) { if (cb.checked) checked++; });
      if (checked === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checked === total) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    selectAll.addEventListener('change', function () {
      var checked = selectAll.checked;
      var rowCheckboxes = table.querySelectorAll('tbody input.row-select');
      rowCheckboxes.forEach(function (cb) { cb.checked = checked; });
    });

    table.addEventListener('change', function (e) {
      if (e.target && e.target.matches('input.row-select')) {
        updateSelectAllState();
      }
    });

    // initialize state
    updateSelectAllState();
  })();
</script>

<script>
  (function () {
    var tabButtons = document.querySelectorAll('.tab-btn');
    var table = document.querySelector('.inventory-table');
    if (!tabButtons.length || !table) return;

    var tabMap = {
      all: ['*'],
      new: ['Under Review', 'Pending'],
      pending: ['Pending'],
      'in-process': ['In Process', 'Approved', 'Out for Delivery'],
      delivered: ['Delivered'],
      completed: ['Completed'],
      rejected: ['Rejected']
    };

    function statusForRow(row) {
      var pill = row.querySelector('.col-status .status-pill');
      return pill ? pill.textContent.trim() : '';
    }

    function applyFilter(key) {
      var allowed = tabMap[key];
      var rows = table.querySelectorAll('tbody tr.inventory-row');
      rows.forEach(function (row) {
        var status = statusForRow(row);
        var show = false;
        if (allowed && allowed[0] === '*') {
          show = true;
        } else if (allowed) {
          show = allowed.indexOf(status) !== -1;
        }
        row.style.display = show ? '' : 'none';
      });
    }

    function updateBadges() {
      var counts = {};
      Object.keys(tabMap).forEach(function (k) { counts[k] = 0; });
      var rows = table.querySelectorAll('tbody tr.inventory-row');
      rows.forEach(function (row) {
        var status = statusForRow(row);
        // increment counts for matching tabs
        Object.keys(tabMap).forEach(function (k) {
          var allowed = tabMap[k];
          if (allowed[0] === '*' || allowed.indexOf(status) !== -1) {
            counts[k]++;
          }
        });
      });
      tabButtons.forEach(function (btn) {
        var key = btn.getAttribute('data-key');
        var badge = btn.querySelector('.tab-badge');
        if (badge) badge.textContent = counts[key] || 0;
      });
    }

    tabButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        tabButtons.forEach(function (b) { b.classList.remove('active'); });
        btn.classList.add('active');
        var key = btn.getAttribute('data-key');
        applyFilter(key);
      });
    });

    // initialize UI
    updateBadges();
    // show only 'all' by default
    applyFilter('all');
  })();
</script>

<script>
  // Handle category dropdown changes
  (function() {
    var categoryDropdowns = document.querySelectorAll('.category-dropdown');
    if (!categoryDropdowns.length) return;

    categoryDropdowns.forEach(function(dropdown) {
      // Store original value
      dropdown.setAttribute('data-original-value', dropdown.value || '');
      
      dropdown.addEventListener('change', function() {
        var supplierId = this.getAttribute('data-supplier-id');
        var categoryId = this.value;
        var originalValue = this.getAttribute('data-original-value') || '';
        
        // Make API call to update category
        fetch('/suppliers/update-category/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            supplier_id: supplierId,
            category_id: categoryId || null
          })
        })
        .then(function(response) {
          if (response.ok) {
            return response.json();
          }
          throw new Error('Network response was not ok');
        })
        .then(function(data) {
          if (data.success) {
            // Update the original value
            dropdown.setAttribute('data-original-value', categoryId || '');
            // Optionally show a success message
            console.log('Category updated successfully');
          } else {
            // Revert on error
            dropdown.value = originalValue;
            alert('Error updating category: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(function(error) {
          console.error('Error:', error);
          // Revert on error
          dropdown.value = originalValue;
          alert('Error updating category. Please try again.');
        });
      });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  })();
</script>

<!-- Price Discussion Modal -->
<div id="price-discussion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text);">Add Price Discussion</h3>
      <button id="close-price-discussion-modal" style="background: none; border: none; cursor: pointer; padding: 4px; font-size: 24px; color: var(--muted);">&times;</button>
    </div>
    
    <form id="price-discussion-form">
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text); font-size: 14px;">Supplier *</label>
        <select id="discussion-supplier-select" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--card-bg);">
          <option value="">Select Supplier</option>
          {% for supplier in all_suppliers %}
            <option value="{{ supplier.id }}">{{ supplier.name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text); font-size: 14px;">Item *</label>
        <select id="discussion-item-select" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--card-bg);" disabled>
          <option value="">Select Supplier First</option>
        </select>
        <div id="item-price-info" style="margin-top: 8px; padding: 8px; background: var(--accent); border-radius: 6px; font-size: 13px; color: var(--text); display: none;">
          Current Price: <strong id="current-price-display">—</strong>
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text); font-size: 14px;">Discussed Price (OMR) *</label>
        <input type="number" id="discussion-price" required step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;" placeholder="0.00">
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text); font-size: 14px;">Discussion Date *</label>
        <input type="datetime-local" id="discussion-date" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text); font-size: 14px;">Notes</label>
        <textarea id="discussion-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-family: var(--font-stack); resize: vertical;" placeholder="Add notes about the price discussion..."></textarea>
      </div>
      
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button type="button" id="cancel-price-discussion" style="padding: 10px 20px; border: 1px solid var(--border); background: white; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text);">Cancel</button>
        <button type="submit" style="padding: 10px 20px; background: var(--focus); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Add Discussion</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    var modal = document.getElementById('price-discussion-modal');
    var openBtn = document.getElementById('add-price-discussion-btn');
    var closeBtn = document.getElementById('close-price-discussion-modal');
    var cancelBtn = document.getElementById('cancel-price-discussion');
    var form = document.getElementById('price-discussion-form');
    var supplierSelect = document.getElementById('discussion-supplier-select');
    var itemSelect = document.getElementById('discussion-item-select');
    var priceInput = document.getElementById('discussion-price');
    var dateInput = document.getElementById('discussion-date');
    var notesInput = document.getElementById('discussion-notes');
    var priceInfo = document.getElementById('item-price-info');
    var currentPriceDisplay = document.getElementById('current-price-display');
    
    // Supplier items data from Django
    var supplierItems = {{ supplier_items_json|safe }};
    
    // Set default date to now
    var now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    dateInput.value = now.toISOString().slice(0, 16);
    
    // Open modal
    if (openBtn) {
      openBtn.addEventListener('click', function() {
        modal.style.display = 'flex';
      });
    }
    
    // Close modal
    function closeModal() {
      modal.style.display = 'none';
      form.reset();
      itemSelect.disabled = true;
      itemSelect.innerHTML = '<option value="">Select Supplier First</option>';
      priceInfo.style.display = 'none';
    }
    
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    
    // Close on outside click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    // Update items when supplier changes
    if (supplierSelect) {
      supplierSelect.addEventListener('change', function() {
        var supplierId = parseInt(this.value);
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = !supplierId;
        priceInfo.style.display = 'none';
        
        if (supplierId && supplierItems[supplierId]) {
          var items = supplierItems[supplierId];
          items.forEach(function(item) {
            var option = document.createElement('option');
            option.value = item.id;
            var label = item.item_code + ' - ' + item.item_name;
            if (item.variation) label += ' (' + item.variation + ')';
            option.textContent = label;
            option.setAttribute('data-price', item.current_price);
            option.setAttribute('data-unit', item.base_unit);
            itemSelect.appendChild(option);
          });
        }
      });
    }
    
    // Update price info when item changes
    if (itemSelect) {
      itemSelect.addEventListener('change', function() {
        var selectedOption = this.options[this.selectedIndex];
        if (selectedOption && selectedOption.value) {
          var price = selectedOption.getAttribute('data-price');
          var unit = selectedOption.getAttribute('data-unit');
          currentPriceDisplay.textContent = 'OMR ' + parseFloat(price).toFixed(2) + ' / ' + unit;
          priceInfo.style.display = 'block';
        } else {
          priceInfo.style.display = 'none';
        }
      });
    }
    
    // Handle form submission
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        var supplierItemId = itemSelect.value;
        var discussedPrice = priceInput.value;
        var discussedDate = dateInput.value;
        var notes = notesInput.value;
        
        if (!supplierItemId || !discussedPrice || !discussedDate) {
          alert('Please fill in all required fields');
          return;
        }
        
        // Convert local datetime to ISO format
        var dateObj = new Date(discussedDate);
        var isoDate = dateObj.toISOString();
        
        // Make API call
        fetch('/api/add-price-discussion/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            supplier_item_id: supplierItemId,
            discussed_price: discussedPrice,
            discussed_date: isoDate,
            notes: notes
          })
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            alert('Price discussion added successfully!');
            closeModal();
            // Optionally reload the page or update UI
            window.location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(function(error) {
          console.error('Error:', error);
          alert('Error adding price discussion. Please try again.');
        });
      });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  })();
</script>

{% endblock %}


