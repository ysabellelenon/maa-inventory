{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
  <div class="page-header inventory-header">
    <div style="display:flex;flex-direction:column;">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href="{% url 'dashboard' %}">Dashboard</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <a href="{% url 'supplier_stock' %}">Supplier Stock</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <span class="active" aria-current="page">New Stock Order</span>
      </nav>
      <h2 style="margin-top:6px;">New Stock Order</h2>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <!-- Save button intentionally removed per design -->
    </div>
  </div>

  <div class="inventory-container">
    <div class="request-layout" style="display:flex;gap:18px;align-items:stretch;">
      <div class="request-left" style="flex:0 0 360px;min-width:320px;">
        <div class="panel-border" style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <label class="field-label">Select Branch</label>
          <select id="branch-select" class="panel-input" aria-label="Select Branch">
            <option value="">Select branch</option>
            {% for brand_data in brands_branches %}
            <optgroup label="{{ brand_data.name }}">
              {% for branch in brand_data.branches %}
              <option value="{{ branch.id }}">{{ branch.name }}</option>
              {% endfor %}
            </optgroup>
            {% endfor %}
          </select>
        </div>

        <div class="panel-border" style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="margin-bottom:8px;">
            <input id="supplier-search" class="panel-input" placeholder="Search by supplier name" aria-label="Search suppliers" />
          </div>
          <div class="suppliers-list" id="suppliers-list" style="max-height:385px;overflow:auto;border-top:1px solid var(--border);">
            {% for supplier in suppliers %}
            <div class="supplier-row" data-supplier-id="{{ supplier.id }}" data-name="{{ supplier.name }}" data-branches="{{ supplier.branches|join:',' }}" style="padding:12px 10px;border-bottom:1px solid #f3f4f6;display:none;flex;align-items:center;justify-content:space-between;cursor:pointer;">
              <div style="flex:1;min-width:0;">
                <div class="supplier-name" style="font-weight:600;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ supplier.name }}</div>
                <div style="font-size:12px;color:#6b7280;margin-top:4px;">{{ supplier.category }}</div>
              </div>
              <div style="margin-left:12px;color:#6b7280;">›</div>
            </div>
            {% endfor %}
            <div id="no-suppliers" style="padding:20px;text-align:center;color:#6b7280;display:none;">
              No suppliers available for selected branch
            </div>
          </div>
        </div>
      </div>

      <div class="request-right panel-border" style="flex:1;min-width:0;background:var(--card-bg);border-radius:8px;padding:18px;display:flex;flex-direction:column;">
        <div>
          <div id="cart-header" style="display:none;font-weight:700;padding:10px 12px;background:rgba(16,24,40,0.02);border-radius:6px;margin-bottom:12px;">
            <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;">
              <div>Item Name</div>
              <div style="text-align:right;">Price</div>
              <div style="text-align:right;">QTY</div>
            </div>
          </div>
          <div id="cart-list" style="display:flex;flex-direction:column;gap:8px;overflow:auto;flex:1 1 auto;">
          <div id="cart-empty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#6b7280;">
              <div class="cart-empty-icon" aria-hidden="true" style="margin-bottom:12px;"></div>
              <div id="cart-empty-text">Select a branch to view available suppliers.</div>
            </div>
          </div>
        </div>

        <div id="total-qty-container" style="display:none;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:600;color:var(--text);font-size:15px;">
              Total Qty: <span id="total-qty">0</span>
            </div>
            <div style="font-weight:600;color:var(--text);font-size:15px;">
              Total Price: <span id="total-price">0.00</span>
            </div>
          </div>
        </div>

        <div id="cart-footer" class="cart-footer" aria-hidden="true" style="display:none;">
          <div style="width:100%;display:flex;justify-content:flex-end;padding-top:12px;border-top:1px solid var(--border);">
            <button id="add-to-basket" class="btn-new-request" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;">
              <img src="{% static 'icons/delivery.svg' %}" alt="" style="width:16px;height:16px;filter:brightness(0) invert(1);" />
              <span>Place Request</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var branchSelect = document.getElementById('branch-select');
      var supplierSearch = document.getElementById('supplier-search');
      var suppliersList = document.getElementById('suppliers-list');
      var cartList = document.getElementById('cart-list');
      var cartEmpty = document.getElementById('cart-empty');
      var cartFooter = document.getElementById('cart-footer');
      var noSuppliers = document.getElementById('no-suppliers');
      var selectedSupplierId = null;
      var itemsContainer = null;
      
      // Items data from server (filtered to only show items in Supplier Stock)
      var itemsData = [
        {% for it in items %}
        {
          code: "{{ it.code }}",
          name: "{{ it.name }}",
          supplier_id: {{ it.supplier_id }},
          supplier_name: "{{ it.supplier_name }}",
          branches: [{{ it.branches|join:',' }}],
          price_per_unit: {% if it.price_per_unit %}{{ it.price_per_unit }}{% else %}null{% endif %},
          available_quantity: {% if it.available_quantity %}{{ it.available_quantity }}{% else %}0{% endif %},
          pending_quantity: {% if it.pending_quantity %}{{ it.pending_quantity }}{% else %}0{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];

      function updateVisibleSuppliers() {
        var branchId = branchSelect.value;
        var q = supplierSearch.value.trim().toLowerCase();
        var visibleCount = 0;
        
        Array.prototype.forEach.call(suppliersList.querySelectorAll('.supplier-row'), function (row) {
          var name = row.getAttribute('data-name') || '';
          var branches = row.getAttribute('data-branches') || '';
          var branchIds = branches ? branches.split(',') : [];
          var matchesBranch = !branchId || branchIds.indexOf(branchId) !== -1;
          var matchesQuery = !q || name.toLowerCase().indexOf(q) !== -1;
          
          if (matchesBranch && matchesQuery) {
            row.style.display = 'flex';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        });
        
        // Show/hide "no suppliers" message
        if (branchId && visibleCount === 0) {
          noSuppliers.style.display = 'block';
        } else {
          noSuppliers.style.display = 'none';
        }
      }
      
      function showItemsForSupplier(supplierId) {
        var branchId = branchSelect.value;
        if (!branchId) return;
        
        // Filter items for this supplier and branch
        var filteredItems = itemsData.filter(function(item) {
          return item.supplier_id == supplierId && item.branches.indexOf(parseInt(branchId)) !== -1;
        });
        
        // Clear cart first
        Array.prototype.slice.call(cartList.querySelectorAll('.cart-item')).forEach(function (el) { el.remove(); });
        
        // Show items in the cart area (right side) with quantity controls
        if (filteredItems.length === 0) {
        cartEmpty.style.display = 'flex';
          document.getElementById('cart-empty-text').textContent = 'No items available for this supplier and branch.';
        var cartHeader = document.getElementById('cart-header');
        if (cartHeader) cartHeader.style.display = 'none';
          var totalQtyContainer = document.getElementById('total-qty-container');
          if (totalQtyContainer) totalQtyContainer.style.display = 'none';
        if (cartFooter) {
          cartFooter.style.display = 'none';
          cartFooter.setAttribute('aria-hidden', 'true');
        }
        } else {
          // Hide empty message
          cartEmpty.style.display = 'none';
          
          // Show header
        var cartHeader = document.getElementById('cart-header');
        if (cartHeader) cartHeader.style.display = 'block';
          
          // Show total qty container
          var totalQtyContainer = document.getElementById('total-qty-container');
          if (totalQtyContainer) totalQtyContainer.style.display = 'block';
          
          // Show footer
        if (cartFooter) {
          cartFooter.style.display = 'block';
          cartFooter.setAttribute('aria-hidden', 'false');
        }
          
          // Add items to cart area with quantity controls
          filteredItems.forEach(function(item) {
            var cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.setAttribute('data-code', item.code);
            cartItem.setAttribute('data-name', item.name);
            // Item layout with grid: Item Name | Price | QTY Controls
            cartItem.style.display = 'grid';
            cartItem.style.gridTemplateColumns = '2fr 1fr 1fr';
            cartItem.style.gap = '12px';
            cartItem.style.alignItems = 'center';
            cartItem.style.padding = '12px';
            cartItem.style.borderBottom = '1px solid #f3f4f6';
            
        var left = document.createElement('div');
            var availableQtyText = item.available_quantity ? '<div style="font-size:11px;color:#10b981;margin-top:2px;">Available: ' + item.available_quantity.toFixed(0) + ' units</div>' : '';
            var pendingQtyText = item.pending_quantity && item.pending_quantity > 0 ? '<div style="font-size:11px;color:#F59E0B;margin-top:2px;">Pending: ' + item.pending_quantity.toFixed(0) + ' units</div>' : '';
            left.innerHTML = '<div class="cart-item-name">' + item.name + '</div><div class="cart-item-code">Item Code: ' + item.code + '</div>' + availableQtyText + pendingQtyText;
            
            var priceDiv = document.createElement('div');
            priceDiv.style.textAlign = 'right';
            var price = item.price_per_unit;
            priceDiv.innerHTML = '<div style="font-weight:500;color:var(--text);">' + (price ? parseFloat(price).toFixed(2) : '—') + '</div>';
            
        var right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';
            right.style.justifyContent = 'flex-end';
            
            // Quantity controls
        var dec = document.createElement('button');
        dec.type = 'button';
        dec.className = 'qty-decrease';
        dec.style.border = '1px solid #e6e6e6';
        dec.style.background = 'transparent';
        dec.style.borderRadius = '6px';
        dec.style.width = '32px';
        dec.style.height = '32px';
        dec.textContent = '−';
            
        var input = document.createElement('input');
        input.className = 'qty-input';
        input.type = 'number';
            input.value = '0';
            input.min = '0';
            input.max = item.available_quantity ? Math.floor(item.available_quantity) : '999999';
        input.style.width = '48px';
        input.style.textAlign = 'center';
        input.style.border = '1px solid #e6e6e6';
        input.style.borderRadius = '6px';
        input.style.height = '32px';
            
        var inc = document.createElement('button');
        inc.type = 'button';
        inc.className = 'qty-increase';
        inc.style.border = '1px solid #e6e6e6';
        inc.style.background = 'transparent';
        inc.style.borderRadius = '6px';
        inc.style.width = '32px';
        inc.style.height = '32px';
        inc.textContent = '+';
            
        right.appendChild(dec);
        right.appendChild(input);
        right.appendChild(inc);
            
            cartItem.appendChild(left);
            cartItem.appendChild(priceDiv);
            cartItem.appendChild(right);
            cartList.appendChild(cartItem);
          });
          
          // Update total qty after adding items
          updateTotalQty();
        }
      }
      
      function updateTotalQty() {
        var total = 0;
        var totalPrice = 0;
        var inputs = cartList.querySelectorAll('.qty-input');
        Array.prototype.forEach.call(inputs, function(input) {
          var qty = parseInt(input.value || '0', 10);
          total += qty;
          
          // Calculate price for this item
          var cartItem = input.closest('.cart-item');
          if (cartItem) {
            var itemCode = cartItem.getAttribute('data-code');
            // Find the item in itemsData to get price_per_unit
            var item = itemsData.find(function(it) {
              return it.code === itemCode;
            });
            if (item && item.price_per_unit) {
              totalPrice += parseFloat(item.price_per_unit) * qty;
            }
          }
        });
        var totalQtyEl = document.getElementById('total-qty');
        if (totalQtyEl) {
          totalQtyEl.textContent = total;
        }
        var totalPriceEl = document.getElementById('total-price');
        if (totalPriceEl) {
          totalPriceEl.textContent = totalPrice.toFixed(2);
        }
      }

      branchSelect && branchSelect.addEventListener('change', function () {
        // Reset supplier selection
        selectedSupplierId = null;
        
        // clear cart when branch changes
        Array.prototype.slice.call(cartList.querySelectorAll('.cart-item')).forEach(function (el) { el.remove(); });
        cartEmpty.style.display = 'flex';
        document.getElementById('cart-empty-text').textContent = 'Select a supplier to view available items.';
        // hide header when cart is empty
        var cartHeader = document.getElementById('cart-header');
        if (cartHeader) cartHeader.style.display = 'none';
        // hide total qty container when cart empty
        var totalQtyContainer = document.getElementById('total-qty-container');
        if (totalQtyContainer) totalQtyContainer.style.display = 'none';
        // hide footer when cart empty
        if (cartFooter) {
          cartFooter.style.display = 'none';
          cartFooter.setAttribute('aria-hidden', 'true');
        }
        updateTotalQty();
        updateVisibleSuppliers();
      });

      supplierSearch && supplierSearch.addEventListener('input', function () {
        updateVisibleSuppliers();
      });
      
      // Handle supplier click
      suppliersList && suppliersList.addEventListener('click', function (e) {
        var row = e.target.closest && e.target.closest('.supplier-row');
        if (!row || row.style.display === 'none') return;
        var supplierId = row.getAttribute('data-supplier-id');
        if (!supplierId) return;
        selectedSupplierId = supplierId;
        showItemsForSupplier(supplierId);
      });

      function updateTotalQty() {
        var total = 0;
        var totalPrice = 0;
        var inputs = cartList.querySelectorAll('.qty-input');
        Array.prototype.forEach.call(inputs, function(input) {
          var qty = parseInt(input.value || '0', 10);
          total += qty;
          
          // Calculate price for this item
          var cartItem = input.closest('.cart-item');
          if (cartItem) {
            var itemCode = cartItem.getAttribute('data-code');
            // Find the item in itemsData to get price_per_unit
            var item = itemsData.find(function(it) {
              return it.code === itemCode;
            });
            if (item && item.price_per_unit) {
              totalPrice += parseFloat(item.price_per_unit) * qty;
            }
          }
        });
        var totalQtyEl = document.getElementById('total-qty');
        if (totalQtyEl) {
          totalQtyEl.textContent = total;
        }
        var totalPriceEl = document.getElementById('total-price');
        if (totalPriceEl) {
          totalPriceEl.textContent = totalPrice.toFixed(2);
        }
      }

      // cart quantity controls (delegated)
      cartList && cartList.addEventListener('click', function (e) {
        var dec = e.target.closest && e.target.closest('.qty-decrease');
        var inc = e.target.closest && e.target.closest('.qty-increase');
        if (dec || inc) {
          var container = (dec || inc).closest && (dec || inc).closest('.cart-item');
          if (!container) return;
          var input = container.querySelector('.qty-input');
          var itemCode = container.getAttribute('data-code');
          
          // Get available quantity for this item
          var item = itemsData.find(function(it) {
            return it.code === itemCode && it.supplier_id == selectedSupplierId;
          });
          var maxQty = item && item.available_quantity ? item.available_quantity : 999999;
          
          var val = parseInt(input.value || '0', 10);
          if (dec) val = Math.max(0, val - 1);
          if (inc) val = Math.min(maxQty, val + 1);  // Don't exceed available quantity
          input.value = val;
          updateTotalQty();
        }
      });
      
      // Also update total when quantity is manually typed
      cartList && cartList.addEventListener('input', function (e) {
        if (e.target && e.target.classList.contains('qty-input')) {
          var input = e.target;
          var container = input.closest('.cart-item');
          if (container) {
            var itemCode = container.getAttribute('data-code');
            var item = itemsData.find(function(it) {
              return it.code === itemCode && it.supplier_id == selectedSupplierId;
            });
            var maxQty = item && item.available_quantity ? Math.floor(item.available_quantity) : 999999;
            
            // Validate quantity against max available
            var val = parseInt(input.value || '0', 10);
            if (val > maxQty) {
              input.value = maxQty;
              alert('Cannot order more than ' + maxQty + ' units. This is the maximum available in supplier stock.');
            } else if (val < 0) {
              input.value = 0;
          }
          }
          updateTotalQty();
        }
      });

      // Place Request handler
      var addToBasket = document.getElementById('add-to-basket');
      addToBasket && addToBasket.addEventListener('click', function () {
        var branchId = branchSelect ? branchSelect.value : null;
        var supplierId = selectedSupplierId;
        
        if (!branchId) {
          alert('Please select a branch');
          return;
        }
        
        if (!supplierId) {
          alert('Please select a supplier');
          return;
        }
        
        // Collect items with quantities > 0
        var orderItems = [];
        var cartItems = Array.prototype.slice.call(cartList.querySelectorAll('.cart-item'));
        
        cartItems.forEach(function(cartItem) {
          var qtyInput = cartItem.querySelector('.qty-input');
          var qty = parseInt(qtyInput.value || '0', 10);
          
          if (qty > 0) {
            var itemCode = cartItem.getAttribute('data-code');
            var itemName = cartItem.getAttribute('data-name');
            
            // Find price from itemsData
            var item = itemsData.find(function(it) {
              return it.code === itemCode;
            });
            
            var price = item && item.price_per_unit ? parseFloat(item.price_per_unit) : 0;
            
            orderItems.push({
              code: itemCode,
              name: itemName,
              quantity: qty,
              price: price
            });
          }
        });
        
        if (orderItems.length === 0) {
          alert('Please add at least one item with quantity > 0');
          return;
        }
        
        // Disable button during request
        addToBasket.disabled = true;
        addToBasket.textContent = 'Processing...';
        
        // Send POST request
        fetch('{% url "new_request" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            branch_id: branchId,
            supplier_id: supplierId,
            items: orderItems
          })
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            alert('Purchase Order created successfully!\\nPO Code: ' + data.po_code + '\\n\\nEmail has been sent to the supplier.');
            // Redirect to item requests page
            window.location.href = '{% url "item_requests" %}';
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(function(error) {
          alert('Error creating order: ' + error.message);
        })
        .finally(function() {
          addToBasket.disabled = false;
          addToBasket.innerHTML = '<img src="{% static "icons/delivery.svg" %}" alt="" style="width:16px;height:16px;filter:brightness(0) invert(1);" /><span>Place Request</span>';
        });
      });
    })();
  </script>

{% endblock %}


