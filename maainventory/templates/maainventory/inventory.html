{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
  <div class="page-header inventory-header">
    <div style="display:flex;flex-direction:column;">
      <h2>Warehouse Inventory</h2>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <a class="btn-new-request" href="{% url 'add_item' %}" aria-label="Add Item">
        <img src="{% static 'icons/plus.svg' %}" alt="" />
        <span>Add Item</span>
      </a>
    </div>
  </div>

  <div class="inventory-container">
    <div class="inventory-card">
      <div class="table-actions">
        <div class="table-actions-left">
          <div class="table-search">
            <img src="{% static 'icons/search.svg' %}" class="table-search-icon" alt="Search" />
            <input class="table-search-input" placeholder="Search by item or code" aria-label="Search inventory" />
          </div>
          <form method="get" action="{% url 'inventory' %}" class="category-filter-form">
            <select id="category-filter" name="category" class="category-filter-select" aria-label="Filter by category" onchange="this.form.submit()">
              <option value="" {% if not current_category %}selected{% endif %}>All categories</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if current_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
      <div class="table-wrapper">
      <div class="table-wrapper-inner">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="col-check"></th>
            <th class="col-code">Item Code</th>
            <th class="col-name">Item Name</th>
            <th class="col-category">Category</th>
            <th class="col-min">MIN</th>
            <th class="col-qty">Qty</th>
            <th class="col-remaining">Remaining</th>
            <th class="col-price">Price</th>
            <th class="col-unit">Base Unit</th>
            <th class="col-status">Status</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="inventory-row {% if item.status == 'LOW' %}row-low{% endif %}" style="cursor: pointer;" title="Click to open item">
              <td class="col-check"><input type="checkbox" aria-label="select {{ item.code }}" /></td>
              <td class="col-code">
                <div class="item-meta">
                  <div class="item-title">{{ item.code }}</div>
                </div>
              </td>
              <td class="col-name">
                <div class="item-meta">
                  <div class="item-title">{{ item.name }}</div>
                </div>
              </td>
              <td class="col-category">{{ item.category|default:"—" }}</td>
              <td class="col-min">{{ item.min_stock_qty }}</td>
              <td class="col-qty">{{ item.qty|default:"0" }}</td>
              <td class="col-remaining">{{ item.remaining|default:"0" }}</td>
              <td class="col-price">{{ item.price|default:"—" }}</td>
              <td class="col-unit">{{ item.base_unit|default:"—" }}</td>
              <td class="col-status">
                <span class="status-pill {% if item.status == 'LOW' %}status-low{% else %}status-good{% endif %}">{{ item.status }}</span>
              </td>
              <td class="col-action">
                <div class="action-btn-container">
                  <button class="action-btn" aria-label="More actions"
                          data-code="{{ item.code }}"
                          data-name="{{ item.name }}">
                    <img src="{% static 'icons/more.svg' %}" alt="More" class="action-icon" />
                  </button>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="11" class="table-empty-message">
                No inventory items found. Click "Add Item" to add one.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      </div>
      <div class="table-footer">
        <div class="table-footer-left">
          <label class="show-label">Show
            <select class="page-size" aria-label="Results per page">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span class="entries-info">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
          </span>
        </div>
        <div class="table-footer-right">
          {% if page_obj.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?{% if current_category %}category={{ current_category }}&{% endif %}page={{ page_obj.previous_page_number }}" class="page-prev" aria-label="Previous page">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </a>
            {% else %}
            <span class="page-prev" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </span>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="page-num active" aria-current="page">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?{% if current_category %}category={{ current_category }}&{% endif %}page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == 1 or num == page_obj.paginator.num_pages %}
                <a href="?{% if current_category %}category={{ current_category }}&{% endif %}page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                <span class="page-dots">…</span>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?{% if current_category %}category={{ current_category }}&{% endif %}page={{ page_obj.next_page_number }}" class="page-next" aria-label="Next page">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </a>
            {% else %}
            <span class="page-next" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </span>
            {% endif %}
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>


<!-- Side panel: Audit / Manage item -->
<div class="overlay" hidden></div>
<div class="action-menu" hidden role="menu" aria-hidden="true">
  <button class="action-menu-item" data-action="delete" style="color: #dc2626;">Delete</button>
</div>
<aside class="side-panel" aria-hidden="true" hidden>
  <div class="side-panel-inner">
    

    <div class="panel-body">
      <section class="panel-left">
        <div class="panel-title-wrap">
          <h3 class="panel-title">
            <img src="{% static 'icons/inventory.svg' %}" class="title-icon" alt="" />
            Manage Item Stock
          </h3>
        </div>
        <!-- product summary removed from left panel (now shown on the right) -->

        <!-- Adjustment Type group removed -->

        <div class="panel-section">
          <label class="field-label field-label--large">Current Inventory Status</label>
          <div class="panel-section grid-top">
            <div>
              <label class="field-label">Total Stock</label>
              <input class="panel-input" type="number" value="15000" disabled />
            </div>
            <div>
              <label class="field-label">MIN</label>
              <input class="panel-input" type="number" value="5000" />
            </div>
          </div>
          <div class="panel-section stacked-fields">
            <div>
              <label class="field-label">Warehouse Stock</label>
              <input class="panel-input" type="number" value="9200" />
            </div>
            <div>
              <label class="field-label">Supplier Hold (Total)</label>
              <input class="panel-input" type="number" value="1000" />
            </div>
          </div>
        </div>

        <div class="panel-section">
          <label class="field-label field-label--large">Adjustment Reason</label>
          <div class="reason-grid">
            <button class="reason-btn">Damage</button>
            <button class="reason-btn">Expire</button>
            <button class="reason-btn">Misplacement</button>
            <button class="reason-btn">Thief</button>
            <button class="reason-btn">Stocktake Variance</button>
            <button class="reason-btn">Custom</button>
          </div>
        </div>

        <div class="panel-section">
          <label class="field-label">Note</label>
          <textarea class="panel-textarea" rows="4"></textarea>
        </div>
      </section>

      <aside class="panel-right">
        <button class="panel-close" aria-label="Close panel">×</button>
        <div class="product-detail">
          <div class="detail-header history-header">Product Detail</div>
          <div class="product-summary product-summary--right">
            <img class="product-thumb" src="{% static 'images/sample-item.jpg' %}" alt="" />
            <div class="product-meta">
              <div class="product-name" data-panel-field="name">Manage Item Stock</div>
            </div>
          </div>
          <div class="product-meta-bottom">
            <div class="product-sku" data-panel-field="code">Item Code: —</div>
            <div class="product-supplier" data-panel-field="supplier">Supplier: —</div>
          </div>
        </div>
        <div class="section-separator" aria-hidden="true"></div>

        <div class="history">
          <div class="history-header">Stock History</div>

          <div class="timeline-card" aria-hidden="false">
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">10 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust MIN — from 16000 to 15000 — Reason: Damage
                    <div class="timeline-meta-name">John Paul Bartolome</div>
                  </div>
                </div>
              </div>

              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">09 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust Warehouse Stock — from 9300 to 9200 — Reason: Stocktake Variance
                    <div class="timeline-meta-name">Nada Al-Daghari</div>
                  </div>
                </div>
              </div>

              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">08 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust Supplier Hold (Total) — from 1200 to 1000 — Reason: Expire
                    <div class="timeline-meta-name">Gloria Ysabelle Lenon</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="panel-footer" role="region" aria-label="Panel actions">
      <div class="panel-footer-inner">
        <button class="btn-cancel">Cancel</button>
        <button class="btn-save primary">Save</button>
      </div>
    </div>

  </div>
</aside>

<script>
  (function () {
    var overlay = document.querySelector('.overlay');
    var panel = document.querySelector('.side-panel');

    function openPanel(data) {
      // populate image if provided (set for all thumbnails in the panel)
      var productImgs = panel.querySelectorAll('.product-thumb');
      if (data.image && productImgs && productImgs.length) {
        productImgs.forEach(function (img) {
          img.setAttribute('src', data.image);
        });
      }

      // populate text fields
      panel.querySelectorAll('[data-panel-field]').forEach(function (el) {
        var key = el.getAttribute('data-panel-field');
        if (data[key]) {
          if (el.classList.contains('product-supplier')) {
            el.textContent = 'Supplier: ' + data[key];
          } else if (el.classList.contains('product-name') || el.classList.contains('detail-name')) {
            el.textContent = data[key];
          } else if (el.classList.contains('product-sku') || el.classList.contains('detail-sku')) {
            el.textContent = 'Item Code: ' + data[key];
          } else {
            el.textContent = data[key];
          }
        }
      });

      overlay.removeAttribute('hidden');
      panel.removeAttribute('hidden');
      panel.setAttribute('aria-hidden', 'false');
      document.body.classList.add('panel-open');
    }

    function closePanel() {
      overlay.setAttribute('hidden', '');
      panel.setAttribute('hidden', '');
      panel.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('panel-open');
    }

    var actionMenu = document.querySelector('.action-menu');
    var currentActionButton = null;

    function showActionMenu(button) {
      if (!actionMenu) return;
      currentActionButton = button;
      var rect = button.getBoundingClientRect();
      // temporarily show menu to measure its width
      actionMenu.removeAttribute('hidden');
      actionMenu.setAttribute('aria-hidden', 'false');
      // ensure it's not visible while measuring (keeps flow)
      actionMenu.style.left = '-9999px';
      actionMenu.style.top = '-9999px';
      var menuWidth = actionMenu.offsetWidth || 160;
      var left = rect.right + window.scrollX - menuWidth; // align right edges
      var top = rect.bottom + window.scrollY + 6;
      // clamp to viewport
      var minLeft = 8 + window.scrollX;
      if (left < minLeft) left = minLeft;
      actionMenu.style.left = left + 'px';
      actionMenu.style.top = top + 'px';
    }

    function hideActionMenu() {
      if (!actionMenu) return;
      actionMenu.setAttribute('hidden', '');
      actionMenu.setAttribute('aria-hidden', 'true');
      currentActionButton = null;
    }

    document.addEventListener('click', function (e) {
      var manageBtn = e.target.closest && e.target.closest('.action-btn');
      // Click on the More action button -> toggle menu
      if (manageBtn) {
        e.preventDefault();
        // if menu is open and the same button was clicked, hide it
        if (actionMenu && actionMenu.getAttribute('aria-hidden') === 'false' && currentActionButton === manageBtn) {
          hideActionMenu();
        } else {
          showActionMenu(manageBtn);
        }
        return;
      }

      // Menu action clicked
      var menuItem = e.target.closest && e.target.closest('.action-menu-item');
      if (menuItem && currentActionButton) {
        e.preventDefault();
        var action = menuItem.getAttribute('data-action');
        var btn = currentActionButton;
        var code = btn.getAttribute('data-code') || '—';
        var name = btn.getAttribute('data-name') || 'this item';
        hideActionMenu();
        if (action === 'delete') {
          if (confirm('Are you sure you want to delete "' + name + '"? This action cannot be undone.')) {
            window.location.href = '/inventory/delete/' + encodeURIComponent(code) + '/';
          }
        }
        return;
      }

      // close panel or menu when clicking close/cancel or overlay
      if (e.target.closest && (e.target.closest('.panel-close') || e.target.closest('.btn-cancel') || e.target === overlay)) {
        e.preventDefault();
        hideActionMenu();
        closePanel();
        return;
      }

      // click outside menu hides it
      if (actionMenu && !e.target.closest('.action-menu')) {
        hideActionMenu();
      }
    });
  })();
</script>
  <script>
    (function () {
      var reasonGrid = document.querySelector('.reason-grid');
      if (!reasonGrid) return;

      reasonGrid.addEventListener('click', function (e) {
        var btn = e.target.closest && e.target.closest('.reason-btn');
        if (!btn) return;
        // single-select behaviour: clear others then activate clicked
        reasonGrid.querySelectorAll('.reason-btn').forEach(function (b) {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
      });
    })();
  </script>
  <script>
    (function () {
      // Make entire row clickable to open the inventory edit page (ignore interactive controls)
      var table = document.querySelector('.inventory-table');
      if (!table) return;

      table.addEventListener('click', function (e) {
        var row = e.target.closest && e.target.closest('tr.inventory-row');
        if (!row) return;
        // ignore clicks on interactive controls inside the row
        if (e.target.closest('input') || e.target.closest('button') || e.target.closest('a') || e.target.closest('.action-btn') || e.target.closest('.action-menu')) {
          return;
        }
        // get code from action button data attribute
        var actionBtn = row.querySelector && row.querySelector('.action-btn');
        var code = actionBtn && actionBtn.getAttribute && actionBtn.getAttribute('data-code');
        if (!code) return;
        window.location.href = '/inventory/edit/' + encodeURIComponent(code) + '/';
      });
    })();
  </script>
{% endblock %}

 
