{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
  <div class="page-header inventory-header">
    <h2>Inventory</h2>
  </div>

  <div class="inventory-container">
    <div class="inventory-card">
      <div class="table-actions">
        <div class="table-actions-left">
          <div class="table-search">
            <img src="{% static 'icons/search.svg' %}" class="table-search-icon" alt="Search" />
            <input class="table-search-input" placeholder="Search by item or code" aria-label="Search inventory" />
          </div>
          <button class="btn-filter">
            <img src="{% static 'icons/filter.svg' %}" alt="" />
            <span>Filter</span>
          </button>
        </div>
      </div>
      <div class="table-wrapper">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="col-check"></th>
            <th class="col-expand"></th>
            <th class="col-code">Item Code</th>
            <th class="col-name">Item Name</th>
            <th class="col-desc">Current Supplier</th>
            <th class="col-init">Qty</th>
            <th class="col-remain">Remaining</th>
            <th class="col-min">MIN</th>
            <th class="col-status">Status</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="inventory-row {% if item.status == 'LOW' %}row-low{% endif %}">
              <td class="col-check"><input type="checkbox" aria-label="select {{ item.code }}" /></td>
              <td class="col-expand">
                <button class="expand" aria-hidden="true">
                  <img class="expand-icon" src="{% static 'icons/chevron-right.svg' %}" alt="" />
                </button>
              </td>
              <td class="col-code">PK-{{ item.code }}</td>
              <td class="col-name">
                <img class="item-thumb" src="{% static 'images/sample-item.jpg' %}" alt="" />
                <div class="item-meta">
                  <div class="item-title">{{ item.name }}</div>
                </div>
              </td>
              <td class="col-desc">{{ item.supplier|default:"—" }}</td>
              <td class="col-init">{{ item.initial_qty }}</td>
              <td class="col-remain">{{ item.remaining_qty }}</td>
              <td class="col-min">{{ item.min_qty }}</td>
              <td class="col-status">
                <span class="status-pill {% if item.status == 'LOW' %}status-low{% else %}status-good{% endif %}">{{ item.status }}</span>
              </td>
              <td class="col-action">
                <div class="action-btn-container">
                  <button class="action-btn" aria-label="More actions"
                          data-code="{{ item.code }}"
                          data-name="{{ item.name }}"
                          data-supplier="{{ item.supplier|default:'—' }}"
                          data-image="{% static 'images/sample-item.jpg' %}">
                    <img src="{% static 'icons/more.svg' %}" alt="More" class="action-icon" />
                  </button>
                </div>
              </td>
            </tr>
            <tr class="inventory-details" hidden>
              <td colspan="10">
                <div class="details-inner">
                  <div class="details-header">Details</div>
                  <div class="details-grid">
                    <div class="detail-item">
                      <div class="detail-label">Foodics</div>
                      <div class="detail-value">{{ item.foodics|default:"123" }}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Talabat</div>
                      <div class="detail-value">{{ item.talabat|default:"45" }}</div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      <div class="table-footer">
        <div class="table-footer-left">
          <label class="show-label">Show
            <select class="page-size" aria-label="Results per page">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span class="entries-info">Showing 1 to 10 of 50 entries</span>
        </div>
        <div class="table-footer-right">
          <nav class="pagination" aria-label="Pagination">
            <button class="page-prev" aria-label="Previous page">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </button>
            <button class="page-num active" aria-current="page">1</button>
            <button class="page-num">2</button>
            <button class="page-num">3</button>
            <span class="page-dots">…</span>
            <button class="page-num">10</button>
            <button class="page-next" aria-label="Next"">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </button>
          </nav>
        </div>
      </div>
    </div>
  </div>

<script>
  (function () {
    var rightIcon = "{% static 'icons/chevron-right.svg' %}";
    var downIcon = "{% static 'icons/chevron-down.svg' %}";
    function toggleRow(button) {
      var row = button.closest('tr');
      if (!row) return;
      var details = row.nextElementSibling;
      var img = button.querySelector('img.expand-icon');
      var expanded = row.classList.toggle('expanded');
      if (details && details.classList.contains('inventory-details')) {
        if (expanded) {
          details.removeAttribute('hidden');
        } else {
          details.setAttribute('hidden', '');
        }
      }
      if (img) {
        img.setAttribute('src', expanded ? downIcon : rightIcon);
      }
      // update aria-expanded
      button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }

    document.addEventListener('click', function (e) {
      var btn = e.target.closest && e.target.closest('.expand');
      if (btn) {
        e.preventDefault();
        toggleRow(btn);
      }
    });
  })();
</script>

<!-- Side panel: Audit / Manage item -->
<div class="overlay" hidden></div>
<div class="action-menu" hidden role="menu" aria-hidden="true">
  <button class="action-menu-item" data-action="edit">Edit Item Info</button>
  <button class="action-menu-item" data-action="adjust">Adjust Stock</button>
</div>
<aside class="side-panel" aria-hidden="true" hidden>
  <div class="side-panel-inner">
    

    <div class="panel-body">
      <section class="panel-left">
        <div class="panel-title-wrap">
          <h3 class="panel-title">
            <img src="{% static 'icons/inventory.svg' %}" class="title-icon" alt="" />
            Manage Item Stock
          </h3>
        </div>
        <!-- product summary removed from left panel (now shown on the right) -->

        <!-- Adjustment Type group removed -->

        <div class="panel-section">
          <label class="field-label field-label--large">Current Inventory Status</label>
          <div class="panel-section grid-top">
            <div>
              <label class="field-label">Total Stock</label>
              <input class="panel-input" type="number" value="15000" disabled />
            </div>
            <div>
              <label class="field-label">MIN</label>
              <input class="panel-input" type="number" value="5000" />
            </div>
          </div>
          <div class="panel-section stacked-fields">
            <div>
              <label class="field-label">Warehouse Stock</label>
              <input class="panel-input" type="number" value="9200" />
            </div>
            <div>
              <label class="field-label">Supplier Hold (Total)</label>
              <input class="panel-input" type="number" value="1000" />
            </div>
          </div>
        </div>

        <div class="panel-section">
          <label class="field-label field-label--large">Adjustment Reason</label>
          <div class="reason-grid">
            <button class="reason-btn">Damage</button>
            <button class="reason-btn">Expire</button>
            <button class="reason-btn">Misplacement</button>
            <button class="reason-btn">Thief</button>
            <button class="reason-btn">Stocktake Variance</button>
            <button class="reason-btn">Custom</button>
          </div>
        </div>

        <div class="panel-section">
          <label class="field-label">Note</label>
          <textarea class="panel-textarea" rows="4"></textarea>
        </div>
      </section>

      <aside class="panel-right">
        <button class="panel-close" aria-label="Close panel">×</button>
        <div class="product-detail">
          <div class="detail-header history-header">Product Detail</div>
          <div class="product-summary product-summary--right">
            <img class="product-thumb" src="{% static 'images/sample-item.jpg' %}" alt="" />
            <div class="product-meta">
              <div class="product-name" data-panel-field="name">Manage Item Stock</div>
            </div>
          </div>
          <div class="product-meta-bottom">
            <div class="product-sku" data-panel-field="code">Item Code: —</div>
            <div class="product-supplier" data-panel-field="supplier">Supplier: —</div>
          </div>
        </div>
        <div class="section-separator" aria-hidden="true"></div>

        <div class="history">
          <div class="history-header">Stock History</div>

          <div class="timeline-card" aria-hidden="false">
            <div class="timeline">
              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">10 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust MIN — from 16000 to 15000 — Reason: Damage
                    <div class="timeline-meta-name">John Paul Bartolome</div>
                  </div>
                </div>
              </div>

              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">09 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust Warehouse Stock — from 9300 to 9200 — Reason: Stocktake Variance
                    <div class="timeline-meta-name">Nada Al-Daghari</div>
                  </div>
                </div>
              </div>

              <div class="timeline-item">
                <div class="timeline-dot" aria-hidden="true"></div>
                <div class="timeline-content">
                  <div class="timeline-title">08 Jun 2024</div>
                  <div class="timeline-meta">
                    Adjust Supplier Hold (Total) — from 1200 to 1000 — Reason: Expire
                    <div class="timeline-meta-name">Gloria Ysabelle Lenon</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="panel-footer" role="region" aria-label="Panel actions">
      <div class="panel-footer-inner">
        <button class="btn-cancel">Cancel</button>
        <button class="btn-save primary">Save</button>
      </div>
    </div>

  </div>
</aside>

<script>
  (function () {
    var overlay = document.querySelector('.overlay');
    var panel = document.querySelector('.side-panel');

    function openPanel(data) {
      // populate image if provided (set for all thumbnails in the panel)
      var productImgs = panel.querySelectorAll('.product-thumb');
      if (data.image && productImgs && productImgs.length) {
        productImgs.forEach(function (img) {
          img.setAttribute('src', data.image);
        });
      }

      // populate text fields
      panel.querySelectorAll('[data-panel-field]').forEach(function (el) {
        var key = el.getAttribute('data-panel-field');
        if (data[key]) {
          if (el.classList.contains('product-supplier')) {
            el.textContent = 'Supplier: ' + data[key];
          } else if (el.classList.contains('product-name') || el.classList.contains('detail-name')) {
            el.textContent = data[key];
          } else if (el.classList.contains('product-sku') || el.classList.contains('detail-sku')) {
            el.textContent = 'Item Code: ' + data[key];
          } else {
            el.textContent = data[key];
          }
        }
      });

      overlay.removeAttribute('hidden');
      panel.removeAttribute('hidden');
      panel.setAttribute('aria-hidden', 'false');
      document.body.classList.add('panel-open');
    }

    function closePanel() {
      overlay.setAttribute('hidden', '');
      panel.setAttribute('hidden', '');
      panel.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('panel-open');
    }

    var actionMenu = document.querySelector('.action-menu');
    var currentActionButton = null;

    function showActionMenu(button) {
      if (!actionMenu) return;
      currentActionButton = button;
      var rect = button.getBoundingClientRect();
      // temporarily show menu to measure its width
      actionMenu.removeAttribute('hidden');
      actionMenu.setAttribute('aria-hidden', 'false');
      // ensure it's not visible while measuring (keeps flow)
      actionMenu.style.left = '-9999px';
      actionMenu.style.top = '-9999px';
      var menuWidth = actionMenu.offsetWidth || 160;
      var left = rect.right + window.scrollX - menuWidth; // align right edges
      var top = rect.bottom + window.scrollY + 6;
      // clamp to viewport
      var minLeft = 8 + window.scrollX;
      if (left < minLeft) left = minLeft;
      actionMenu.style.left = left + 'px';
      actionMenu.style.top = top + 'px';
    }

    function hideActionMenu() {
      if (!actionMenu) return;
      actionMenu.setAttribute('hidden', '');
      actionMenu.setAttribute('aria-hidden', 'true');
      currentActionButton = null;
    }

    document.addEventListener('click', function (e) {
      var manageBtn = e.target.closest && e.target.closest('.action-btn');
      // Click on the More action button -> toggle menu
      if (manageBtn) {
        e.preventDefault();
        // if menu is open and the same button was clicked, hide it
        if (actionMenu && actionMenu.getAttribute('aria-hidden') === 'false' && currentActionButton === manageBtn) {
          hideActionMenu();
        } else {
          showActionMenu(manageBtn);
        }
        return;
      }

      // Menu action clicked
      var menuItem = e.target.closest && e.target.closest('.action-menu-item');
      if (menuItem && currentActionButton) {
        e.preventDefault();
        var action = menuItem.getAttribute('data-action');
        var btn = currentActionButton;
        var data = {
          code: btn.getAttribute('data-code') || '—',
          name: btn.getAttribute('data-name') || '—',
          supplier: btn.getAttribute('data-supplier') || '—',
          image: btn.getAttribute('data-image') || ''
        };
        hideActionMenu();
        if (action === 'adjust') {
          openPanel(data);
        } else if (action === 'edit') {
          // navigate to dedicated edit page for the item
          // encoded code ensures safe URL for special characters
          var editUrl = '/inventory/edit/' + encodeURIComponent(data.code) + '/';
          window.location.href = editUrl;
        }
        return;
      }

      // close panel or menu when clicking close/cancel or overlay
      if (e.target.closest && (e.target.closest('.panel-close') || e.target.closest('.btn-cancel') || e.target === overlay)) {
        e.preventDefault();
        hideActionMenu();
        closePanel();
        return;
      }

      // click outside menu hides it
      if (actionMenu && !e.target.closest('.action-menu')) {
        hideActionMenu();
      }
    });
  })();
</script>
  <script>
    (function () {
      var reasonGrid = document.querySelector('.reason-grid');
      if (!reasonGrid) return;

      reasonGrid.addEventListener('click', function (e) {
        var btn = e.target.closest && e.target.closest('.reason-btn');
        if (!btn) return;
        // single-select behaviour: clear others then activate clicked
        reasonGrid.querySelectorAll('.reason-btn').forEach(function (b) {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
      });
    })();
  </script>
{% endblock %}

 
