{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
<style>
/* Strongly-scoped page overrides: target only when the body has the
   `edit-item-page-open` class so no other pages are affected. */
body.edit-item-page-open .content {
  height: auto !important;
  overflow: visible !important;
  overflow-y: auto !important;
}
body.edit-item-page-open .inventory-container {
  height: auto !important;
  min-height: auto !important;
  max-height: none !important;
  overflow: visible !important;
  overflow-y: visible !important;
}
body.edit-item-page-open .edit-item-page {
  min-height: 100%;
  padding-bottom: 20px;
}
/* Allow internal elements to scroll normally when needed */
body.edit-item-page-open .inventory-container,
body.edit-item-page-open .inventory-container * {
  -webkit-overflow-scrolling: touch;
}
/* Ensure form and aside can display fully */
body.edit-item-page-open .inventory-container form {
  overflow: visible !important;
}
body.edit-item-page-open .inventory-container aside {
  overflow: visible !important;
  max-height: none !important;
}
/* Form input styling */
.form-input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--font-stack);
  font-size: 14px;
}
.form-input:focus {
  border-color: var(--focus);
  outline: none;
  box-shadow: 0 0 0 3px rgba(217,189,125,0.12);
}
.field-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--text);
  font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
  <div class="edit-item-page">
  <div class="page-header inventory-header">
    <div style="display:flex;flex-direction:column;">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href="{% url 'dashboard' %}">Dashboard</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <a href="{% url 'inventory' %}">Inventory</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <span class="active" aria-current="page">{{ item.name }}</span>
      </nav>
      <h2 style="margin-top:6px;">{{ item.name }}</h2>
      <h3 class="item-submeta"><strong>Item Code:</strong> {{ item.code }} &nbsp;•&nbsp; <strong>Category:</strong> {{ item.category|default:"—" }}</h3>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <button type="submit" form="item-form" class="btn-save-inline" aria-label="Save">
        <img src="{% static 'icons/check.svg' %}" alt="" />
        <span>Save</span>
      </button>
    </div>
  </div>

  <div class="inventory-container">
    {% if messages %}
      <div style="margin-bottom: 20px;">
        {% for message in messages %}
          <div style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; background: {% if message.tags == 'error' %}#fee2e2{% elif message.tags == 'success' %}#dcfce7{% else %}var(--accent){% endif %}; color: {% if message.tags == 'error' %}#991b1b{% elif message.tags == 'success' %}#166534{% else %}var(--text){% endif %}; border: 1px solid {% if message.tags == 'error' %}#fecaca{% elif message.tags == 'success' %}#bbf7d0{% else %}var(--border){% endif %};">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" action="{% url 'edit_item' code=item.code %}" id="item-form" enctype="multipart/form-data">
      {% csrf_token %}
      
    <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
      <div style="flex:1;">
          <div style="margin-bottom:12px;">
            <div style="font-weight:700;margin-bottom:8px;">Photos</div>
            <div id="photos-container" style="display:flex;flex-direction:row;gap:12px;flex-wrap:wrap;align-items:flex-start;">
              {% for photo in item_photos %}
                <div class="existing-photo" data-photo-id="{{ photo.id }}" style="position:relative;width:140px;height:100px;flex-shrink:0;border-radius:8px;overflow:hidden;border:1px solid #f3f3f3;">
                  <img src="{{ photo.photo.url }}" alt="{{ item.name }}" style="width:100%;height:100%;object-fit:cover;display:block;" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;background:var(--accent);\'>Image Error</div>';">
                  <button type="button" class="delete-existing-photo" data-photo-id="{{ photo.id }}" onclick="deleteExistingPhoto({{ photo.id }})" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center;z-index:10;" title="Delete photo">×</button>
                </div>
              {% endfor %}
              {% if item_photos|length < 5 %}
                <label for="upload-more-photos" id="upload-more-label" style="width:140px;height:100px;flex-shrink:0;border-radius:8px;border:1px dashed #e6e6e6;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#9ca3af;background:var(--accent);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--focus)';this.style.background='#f7e7d0';" onmouseout="this.style.borderColor='#e6e6e6';this.style.background='var(--accent)';">
                  <input type="file" name="photos" id="upload-more-photos" accept="image/*" multiple style="display:none;" onchange="handlePhotoUpload(this)">
                  <span style="font-size:24px;margin-bottom:4px;">+</span>
                  <span style="font-size:12px;text-align:center;">Upload More<br/>Photo</span>
                </label>
              {% endif %}
          </div>
            <div id="photo-upload-status" style="margin-top:8px;font-size:12px;color:#6b7280;"></div>
        </div>

        <div style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="font-weight:700;margin-bottom:6px;">Description</div>
            {{ form.description }}
            {% if form.description.errors %}
              <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                {% for error in form.description.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
        </div>

        <div style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="font-weight:700;margin-bottom:8px;">Basic Details</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div>
                <label class="field-label">{{ form.name.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.name }}
                {% if form.name.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div>
                <label class="field-label">{{ form.base_unit.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.base_unit }}
                {% if form.base_unit.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.base_unit.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div>
                <label class="field-label">{{ form.brand.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.brand }}
                {% if form.brand.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.brand.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div>
                <label class="field-label">{{ form.item_code.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.item_code }}
                {% if form.item_code.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.item_code.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div>
                <label class="field-label">{{ form.min_order_qty.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.min_order_qty }}
                {% if form.min_order_qty.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.min_order_qty.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
            </div>
            <div>
                <label class="field-label">{{ form.min_stock_qty.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.min_stock_qty }}
                {% if form.min_stock_qty.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.min_stock_qty.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
            </div>
            <div>
                <label class="field-label">{{ form.price_per_unit.label }}</label>
                {{ form.price_per_unit }}
                {% if form.price_per_unit.errors %}
                  <div style="color: #991b1b; font-size: 13px; margin-top: 4px;">
                    {% for error in form.price_per_unit.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
            </div>
  </div>
  </div>

  <script>
    (function () {
      // add a body-level marker so we can override parent (.content) styles
      // without changing global CSS. Remove on unload to avoid cross-page leaks.
      try {
        document.body.classList.add('edit-item-page-open');
        window.addEventListener('unload', function () {
          document.body.classList.remove('edit-item-page-open');
        });
      } catch (e) {
        // defensive: if document not available for some reason, ignore
      }
    })();
  </script>

      </div>

      <aside style="flex:0 0 360px;min-width:0;max-width:360px;">
        <div style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="font-weight:700;margin-bottom:8px;">Consumption Overview</div>
          <div style="font-size:20px;font-weight:700;">{{ item.remaining_qty }} {{ item.base_unit }} <span style="color:#6b7280;font-size:12px;">Current Stock</span></div>
          <div style="height:120px;background:#fff;border-radius:8px;margin-top:8px;border:1px solid #f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af;">
            Chart placeholder (consumption data not yet implemented)
          </div>
        </div>

        <!-- Active Branches panel -->
        <div class="branches-panel" style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 class="branches-title" style="margin:0;font-weight:700;font-size:15px;">Active Branches</h3>
          </div>

          <input type="text" id="branch-search" class="panel-input" placeholder="Search branches" aria-label="Search branches" style="margin-top:12px;margin-bottom:12px;">

          <div class="branches-list" style="max-height:260px;overflow:auto;">
            {% for brand_name, branches in branch_groups.items %}
            <div class="branch-group" data-brand="{{ brand_name|lower }}">
              <div class="branch-group-header" style="font-weight:700;padding:8px 0;border-bottom:1px solid #f3f4f6;">{{ brand_name }}</div>
              {% for branch in branches %}
              <label class="branch-item" data-branch-name="{{ branch.name|lower }}" style="display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid #fbfbfb;cursor:pointer;">
                <input type="checkbox" name="branches" value="{{ branch.id }}" form="item-form" {% if branch.is_using %}checked{% endif %} style="width:18px;height:18px;cursor:pointer;accent-color:var(--focus);">
                <span style="font-weight:500;color:var(--text);">{{ branch.name }}</span>
              </label>
              {% empty %}
              <div style="padding:10px 0;color:#6b7280;font-size:13px;">No branches found for {{ brand_name }}</div>
              {% endfor %}
              </div>
            {% empty %}
            <div style="padding:10px 0;color:#6b7280;text-align:center;">No branches available</div>
            {% endfor %}
              </div>
            </div>

        <!-- Branches Using This Item -->
        {% if branches_using_item %}
        <div style="background:var(--card-bg);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="font-weight:700;margin-bottom:8px;">Branches Using This Item</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            {% for branch in branches_using_item %}
            <div style="padding:8px;background:var(--accent);border-radius:6px;border:1px solid var(--border);">
              <div style="font-weight:600;font-size:14px;">{{ branch.name }}</div>
              <div style="font-size:12px;color:#6b7280;">{{ branch.brand.name }}</div>
              </div>
            {% endfor %}
              </div>
            </div>
        {% endif %}
      </aside>
    </div>
    </form>
  </div>
  </div>

  <script>
    (function () {
      // add a body-level marker so we can override parent (.content) styles
      // without changing global CSS. Remove on unload to avoid cross-page leaks.
      try {
        document.body.classList.add('edit-item-page-open');
        window.addEventListener('unload', function () {
          document.body.classList.remove('edit-item-page-open');
        });
      } catch (e) {
        // defensive: if document not available for some reason, ignore
      }
    })();
  </script>

  <script>
    (function () {
      // Branch search functionality
      var branchSearch = document.getElementById('branch-search');
      var branchGroups = document.querySelectorAll('.branch-group');
      
      if (branchSearch) {
        branchSearch.addEventListener('input', function() {
          var query = this.value.trim().toLowerCase();
          
          branchGroups.forEach(function(group) {
            var brandName = group.getAttribute('data-brand') || '';
            var branchItems = group.querySelectorAll('.branch-item');
            var anyMatch = false;
            
            branchItems.forEach(function(item) {
              var branchName = item.getAttribute('data-branch-name') || '';
              if (branchName.includes(query) || brandName.includes(query)) {
                item.style.display = 'flex';
                anyMatch = true;
              } else {
                item.style.display = 'none';
              }
            });
            
            // Hide group if no items match
            if (!anyMatch && query) {
              group.style.display = 'none';
            } else {
              group.style.display = 'block';
            }
          });
        });
      }
    })();
  </script>

  <script>
    // Store selected photos for preview
    let selectedPhotosForUpload = [];
    const maxPhotos = 5;
    const existingCount = {{ item_photos|length }};

    function handlePhotoUpload(input) {
      const files = Array.from(input.files);
      const currentTotal = existingCount + selectedPhotosForUpload.length;
      const remainingSlots = maxPhotos - currentTotal;
      
      const statusDiv = document.getElementById('photo-upload-status');
      const uploadLabel = document.getElementById('upload-more-label');
      
      if (remainingSlots <= 0) {
        statusDiv.innerHTML = '<span style="color: #991b1b;">Maximum 5 photos reached. Please remove some photos before adding more.</span>';
        input.value = '';
        return;
      }
      
      // Add new files to the selection (up to the limit)
      const filesToAdd = files.slice(0, remainingSlots);
      filesToAdd.forEach(file => {
        if (selectedPhotosForUpload.length + existingCount < maxPhotos) {
          selectedPhotosForUpload.push(file);
        }
      });
      
      if (files.length > remainingSlots) {
        statusDiv.innerHTML = `<span style="color: #991b1b;">Only ${remainingSlots} photo(s) were added. Maximum 5 photos per item.</span>`;
      } else {
        statusDiv.innerHTML = `${selectedPhotosForUpload.length} photo(s) ready to upload. Click "Save" to upload.`;
      }
      
      // Show previews
      updatePhotoPreviews();
      
      // Hide upload button if max reached
      const newTotal = existingCount + selectedPhotosForUpload.length;
      if (newTotal >= maxPhotos && uploadLabel) {
        uploadLabel.style.display = 'none';
      }
      
      // Clear the input so user can select more files
      input.value = '';
    }
    
    function updatePhotoPreviews() {
      const photosContainer = document.getElementById('photos-container');
      
      // Remove all existing preview photos
      const existingPreviews = photosContainer.querySelectorAll('.preview-photo');
      existingPreviews.forEach(preview => preview.remove());
      
      // Add new preview photos directly to photos container (before upload button)
      const uploadLabel = document.getElementById('upload-more-label');
      
      selectedPhotosForUpload.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoDiv = document.createElement('div');
          photoDiv.className = 'preview-photo';
          photoDiv.style.cssText = 'position:relative;width:140px;height:100px;flex-shrink:0;border-radius:8px;overflow:hidden;border:1px solid #f3f3f3;';
          
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
          
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.innerHTML = '×';
          removeBtn.style.cssText = 'position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center;z-index:10;';
          removeBtn.onclick = () => removePreviewPhoto(index);
          removeBtn.title = 'Remove photo';
          
          photoDiv.appendChild(img);
          photoDiv.appendChild(removeBtn);
          
          // Insert before upload button if it exists, otherwise append
          if (uploadLabel && uploadLabel.parentNode === photosContainer) {
            photosContainer.insertBefore(photoDiv, uploadLabel);
          } else {
            photosContainer.appendChild(photoDiv);
          }
        };
        reader.readAsDataURL(file);
      });
    }
    
    function removePreviewPhoto(index) {
      selectedPhotosForUpload.splice(index, 1);
      updatePhotoPreviews();
      
      const statusDiv = document.getElementById('photo-upload-status');
      const uploadLabel = document.getElementById('upload-more-label');
      const currentTotal = existingCount + selectedPhotosForUpload.length;
      
      if (selectedPhotosForUpload.length > 0) {
        statusDiv.innerHTML = `${selectedPhotosForUpload.length} photo(s) ready to upload. Click "Save" to upload.`;
      } else {
        statusDiv.innerHTML = '';
      }
      
      // Show upload button if under limit
      if (currentTotal < maxPhotos && uploadLabel) {
        uploadLabel.style.display = 'flex';
      }
    }
    
    // Update file input before form submission
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('item-form');
      const photoInput = document.getElementById('upload-more-photos');
      
      if (form && photoInput) {
        form.addEventListener('submit', function(e) {
          // Update the file input with all selected photos
          if (selectedPhotosForUpload.length > 0) {
            try {
              const dataTransfer = new DataTransfer();
              selectedPhotosForUpload.forEach(file => {
                dataTransfer.items.add(file);
              });
              photoInput.files = dataTransfer.files;
            } catch (e) {
              console.warn('DataTransfer not supported');
            }
          }
        });
      }
    });
    
    // Delete existing photo
    function deleteExistingPhoto(photoId) {
      if (!confirm('Are you sure you want to delete this photo?')) {
        return;
      }
      
      const photoDiv = document.querySelector(`.existing-photo[data-photo-id="${photoId}"]`);
      if (!photoDiv) {
        return;
      }
      
      // Show loading state
      const originalContent = photoDiv.innerHTML;
      photoDiv.style.opacity = '0.5';
      photoDiv.style.pointerEvents = 'none';
      
      fetch(`/inventory/photo/${photoId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the photo from DOM
          photoDiv.remove();
          
          // Show upload button if we're now under 5 photos
          const existingPhotos = document.querySelectorAll('.existing-photo');
          const previewPhotos = document.querySelectorAll('.preview-photo');
          const totalPhotos = existingPhotos.length + previewPhotos.length;
          const uploadLabel = document.getElementById('upload-more-label');
          
          if (totalPhotos < 5 && uploadLabel) {
            uploadLabel.style.display = 'flex';
          }
          
          // Show success message
          const statusDiv = document.getElementById('photo-upload-status');
          if (statusDiv) {
            statusDiv.innerHTML = '<span style="color: #059669;">Photo deleted successfully.</span>';
            setTimeout(() => {
              statusDiv.innerHTML = '';
            }, 3000);
          }
        } else {
          // Restore on error
          photoDiv.innerHTML = originalContent;
          photoDiv.style.opacity = '1';
          photoDiv.style.pointerEvents = 'auto';
          alert(data.error || 'Error deleting photo');
        }
      })
      .catch(error => {
        // Restore on error
        photoDiv.innerHTML = originalContent;
        photoDiv.style.opacity = '1';
        photoDiv.style.pointerEvents = 'auto';
        console.error('Error:', error);
        alert('Error deleting photo. Please try again.');
      });
    }
  </script>

{% endblock %}


