{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/branches.css' %}">
{% endblock %}

{% block content %}
  <div class="page-header branches-header">
    <div class="branches-header-left">
      <h2>Branch Inventory</h2>
      <p class="page-subtitle">Items delivered to each branch. When a branch manager marks a request as Delivered, its items appear here under that branch.</p>
    </div>
    {% if is_procurement_user %}
    <a href="{% url 'branches_configure' %}" class="btn-configure">Configure Packaging</a>
    {% endif %}
  </div>

  <div class="tabs-container branches-tabs">
    <div class="tabs">
      {% for brand in brands_with_branches %}
      <button class="tab-btn {% if forloop.first %}active{% endif %}" data-key="{{ brand.slug }}" type="button" role="tab" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
        {{ brand.name }}{% if brand.branches %} <span class="tab-badge">{{ brand.branches|length }}</span>{% endif %}
      </button>
      {% endfor %}
    </div>
  </div>

  <div class="branches-container branches-items-view">
    {% for brand in brands_with_branches %}
    <div class="tab-panel {% if forloop.first %}active{% endif %}" data-key="{{ brand.slug }}" role="tabpanel" aria-hidden="{% if forloop.first %}false{% else %}true{% endif %}">
      {% for branch in brand.branches %}
      <div class="branch-group branch-items-group collapsed" data-branch-group>
        <div class="branch-items-header" role="button" tabindex="0" aria-expanded="false" aria-controls="branch-body-{{ branch.id }}" id="branch-header-{{ branch.id }}" data-branch-toggle>
          <button type="button" class="branch-toggle" aria-label="Expand or collapse branch" title="Expand or collapse">
            <img class="branch-toggle-icon" src="{% static 'icons/chevron-right.svg' %}" alt="" />
          </button>
          <h3 class="branch-group-title">{{ branch.brand }} — {{ branch.name }}</h3>
        </div>
        <div class="branch-group-body" id="branch-body-{{ branch.id }}" aria-labelledby="branch-header-{{ branch.id }}">
          {% if branch.address %}
          <p class="branch-address">{{ branch.address }}</p>
          {% endif %}
          {% if is_branch_user and branch.id in user_branch_ids %}
          <div class="branch-actions" style="margin-bottom: 12px;">
            <a href="{% url 'branch_packaging' branch.id %}" class="btn-configure" style="display: inline-block; text-decoration: none;">Upload CSV/Excel to deduct packaging</a>
          </div>
          {% endif %}
          {% if branch.items %}
          <div class="table-wrapper">
            <table class="packaging-table branch-items-table">
              <thead>
                <tr>
                  <th>Item Code</th>
                  <th>Item Name</th>
                  <th>Unit</th>
                  <th>MIN</th>
                  <th>Qty Available</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for item in branch.items %}
                <tr class="{% if item.min_order_qty != None and item.qty_available != None and item.qty_available <= item.min_order_qty %}branch-item-low{% endif %}">
                  <td>{{ item.item_code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.base_unit }}</td>
                  <td>{{ item.min_order_qty|default:"—" }}</td>
                  <td>{% if item.qty_available != None %}{{ item.qty_available|floatformat:0 }}{% else %}—{% endif %}</td>
                  <td class="branch-status-cell">
                    {% if item.min_order_qty != None and item.qty_available != None %}
                      {% if item.qty_available <= item.min_order_qty %}
                        <span class="branch-status-low">LOW</span>
                      {% else %}
                        <span class="branch-status-good">Good</span>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="no-items">No items delivered to this branch yet. Items appear here after: Branch Manager requests → Procurement approves → Warehouse marks In Process → Branch Manager marks request as Delivered.</p>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="branches-empty">
        <p>No branches for this brand.</p>
      </div>
      {% endfor %}
    </div>
    {% empty %}
    <div class="branches-empty">
      <p>No branches found.</p>
    </div>
    {% endfor %}
  </div>
  <script>
    (function () {
      var container = document.querySelector('.branches-container');
      if (!container) return;
      var tabBtns = document.querySelectorAll('.tabs-container .tab-btn');
      var panels = container.querySelectorAll('.tab-panel');
      tabBtns.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var key = btn.getAttribute('data-key');
          tabBtns.forEach(function (b) {
            b.classList.toggle('active', b === btn);
            b.setAttribute('aria-selected', b === btn ? 'true' : 'false');
          });
          panels.forEach(function (p) {
            var show = p.getAttribute('data-key') === key;
            p.classList.toggle('active', show);
            p.setAttribute('aria-hidden', show ? 'false' : 'true');
          });
        });
      });
    })();
  </script>
  <script>
    (function () {
      var rightIcon = "{% static 'icons/chevron-right.svg' %}";
      var downIcon = "{% static 'icons/chevron-down.svg' %}";
      document.querySelectorAll('[data-branch-toggle]').forEach(function (header) {
        var group = header.closest('[data-branch-group]');
        var body = group && group.querySelector('.branch-group-body');
        var toggleBtn = header.querySelector('.branch-toggle');
        var icon = header.querySelector('.branch-toggle-icon');
        if (!group || !body || !icon) return;
        function setExpanded(expanded) {
          group.classList.toggle('collapsed', !expanded);
          header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          icon.setAttribute('src', expanded ? downIcon : rightIcon);
        }
        header.addEventListener('click', function (e) {
          if (e.target.closest('a')) return;
          setExpanded(group.classList.contains('collapsed'));
        });
        if (toggleBtn) {
          toggleBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            setExpanded(group.classList.contains('collapsed'));
          });
        }
        header.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            setExpanded(group.classList.contains('collapsed'));
          }
        });
      });
    })();
  </script>
{% endblock %}
