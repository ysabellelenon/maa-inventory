{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/requests.css' %}">
<style>
  /* Prevent horizontal scroll but allow vertical scroll */
  body {
    overflow-x: hidden;
    overflow-y: auto !important;
  }
  
  .content {
    height: auto !important;
    max-height: none !important;
    overflow-y: visible !important;
  }
  
  .inventory-container {
    max-width: 100%;
    overflow-x: hidden;
    height: auto !important;
    max-height: none !important;
    overflow-y: visible !important;
  }
  
  .table-wrapper {
    overflow-x: auto;
    max-width: 100%;
    max-height: none !important;
    height: auto !important;
    overflow-y: visible !important;
  }
  
  /* Override requests.css 50vh limit for this page */
  .inventory-card .table-wrapper {
    max-height: none !important;
  }
  
  /* Compact table layout */
  .inventory-table {
    table-layout: fixed;
    width: 100%;
  }
  
  .inventory-table tbody {
    max-height: none !important;
    overflow: visible !important;
  }
  
  .inventory-table .col-check {
    width: 40px;
  }
  
  .inventory-table .col-name {
    width: 15%;
  }
  
  .inventory-table .col-code {
    width: 110px;
  }
  
  .inventory-table .col-quantity {
    width: 100px;
    text-align: center;
  }
  
  .inventory-table .col-min {
    width: 80px;
    text-align: center;
  }
  
  .inventory-table .col-status {
    width: 90px;
    text-align: center;
  }
  
  .inventory-table .col-requested {
    width: 140px;
  }
  
  /* Make table more compact */
  .inventory-table th,
  .inventory-table td {
    padding: 12px 10px;
  }
  
  /* Status pills */
  .status-pill {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-low {
    background: #FEE2E2;
    color: #991B1B;
  }
  
  .status-good {
    background: #D1FAE5;
    color: #065F46;
  }
  
  /* Row highlight for low stock */
  .row-low {
    background: #FEF2F2 !important;
  }
  
  .row-low:hover {
    background: #FEE2E2 !important;
  }
</style>
{% endblock %}

{% block content %}
  <div class="page-header inventory-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Supplier Stock</h2>
    <a href="{% url 'new_request' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--focus); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background 0.2s; border: 1px solid var(--focus); margin-right: 32px;">
      <img src="{% static 'icons/plus.svg' %}" alt="Add" style="width: 16px; height: 16px; filter: brightness(0) invert(1);" />
      Request Stock
    </a>
  </div>

  <div class="inventory-container">
    <div class="inventory-card">
      <div class="table-actions">
        <div class="table-actions-left">
          <div class="table-search">
            <img src="{% static 'icons/search.svg' %}" class="table-search-icon" alt="Search" />
            <input class="table-search-input" placeholder="Search by supplier, item, or request code" aria-label="Search supplier stock" />
          </div>
          <div style="display: flex; gap: 12px; align-items: center;">
            <select id="supplier-filter" style="padding: 8px 12px; border: 1px solid #D0D5DD; border-radius: 8px; font-size: 14px; color: #101828; background: white; min-width: 180px;">
              <option value="">All Suppliers</option>
              {% for supplier in all_suppliers %}
                <option value="{{ supplier.name }}" {% if selected_supplier == supplier.name %}selected{% endif %}>{{ supplier.name }}</option>
              {% endfor %}
            </select>
            <select id="item-filter" style="padding: 8px 12px; border: 1px solid #D0D5DD; border-radius: 8px; font-size: 14px; color: #101828; background: white; min-width: 180px;">
              <option value="">All Items</option>
              {% for item in all_items %}
                <option value="{{ item.name }}" {% if selected_item == item.name %}selected{% endif %}>{{ item.name }}</option>
              {% endfor %}
            </select>
            <button id="clear-filters" style="padding: 8px 16px; border: 1px solid #D0D5DD; border-radius: 8px; font-size: 14px; color: #475467; background: white; cursor: pointer;">
              Clear
            </button>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" class="select-all" aria-label="Select all stock items" /></th>
            <th class="col-name">Supplier</th>
            <th class="col-code">Item Code</th>
            <th class="col-name">Item Name</th>
            <th class="col-quantity">Quantity</th>
            <th class="col-min">MIN</th>
            <th class="col-status">Status</th>
            <th class="col-code">Request Code</th>
            <th class="col-requested">Confirmed Date</th>
          </tr>
        </thead>
        <tbody>
          {% for stock in stock_items %}
            <tr class="inventory-row {% if stock.is_low_stock %}row-low{% endif %}">
              <td class="col-check"><input type="checkbox" class="row-select" aria-label="select stock #{{ forloop.counter }}" /></td>
              <td class="col-name">
                <div class="item-meta">
                  <div class="item-title">{{ stock.supplier }}</div>
                </div>
              </td>
              <td class="col-code">{{ stock.item_code }}</td>
              <td class="col-name">
                <div class="item-meta">
                  <div class="item-title">{{ stock.item_name }}</div>
                </div>
              </td>
              <td class="col-quantity">
                <span style="font-weight: 600; color: #101828;">{{ stock.quantity }}</span>
                <span style="font-size: 12px; color: #6b7280; margin-left: 4px;">{{ stock.base_unit }}</span>
              </td>
              <td class="col-min">
                <span style="font-weight: 600; color: #6b7280; font-size: 13px;">{{ stock.min_stock_qty }}</span>
                <span style="font-size: 11px; color: #9ca3af; margin-left: 2px;">{{ stock.base_unit }}</span>
              </td>
              <td class="col-status">
                <span class="status-pill {% if stock.is_low_stock %}status-low{% else %}status-good{% endif %}">
                  {% if stock.is_low_stock %}LOW{% else %}GOOD{% endif %}
                </span>
              </td>
              <td class="col-code">
                {% if stock.request_code != "—" %}
                  <a href="{% url 'item_requests' %}" style="color: var(--focus); text-decoration: none; font-weight: 600;">
                    {{ stock.request_code }}
                  </a>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="col-requested">{{ stock.confirmed_at }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px; color: #6b7280;">
                No items in supplier stock yet.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      
      <!-- Totals Section -->
      <div style="margin-top: 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Totals by Supplier -->
        <div style="background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB;">
          <h3 style="font-size: 16px; font-weight: 600; color: #101828; margin: 0 0 16px 0;">Totals by Supplier</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            {% for supplier, total in supplier_totals.items %}
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E5E7EB;">
                <span style="color: #475467; font-size: 14px;">{{ supplier }}</span>
                <span style="color: #101828; font-weight: 600; font-size: 14px;">{{ total|floatformat:0 }} units</span>
              </div>
            {% empty %}
              <p style="color: #6B7280; font-size: 14px; margin: 0;">No data available</p>
            {% endfor %}
          </div>
        </div>
        
        <!-- Totals by Item -->
        <div style="background: #F9FAFB; padding: 20px; border-radius: 8px; border: 1px solid #E5E7EB;">
          <h3 style="font-size: 16px; font-weight: 600; color: #101828; margin: 0 0 16px 0;">Totals by Item (All Suppliers)</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            {% for item, data in item_totals.items %}
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E5E7EB;">
                <span style="color: #475467; font-size: 14px;">{{ item }}</span>
                <span style="color: #101828; font-weight: 600; font-size: 14px;">{{ data.quantity|floatformat:0 }} {{ data.unit }}</span>
              </div>
            {% empty %}
              <p style="color: #6B7280; font-size: 14px; margin: 0;">No data available</p>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- Grand Total -->
      <div style="margin-top: 20px; background: #D9BD7D; padding: 16px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
        <span style="color: white; font-size: 16px; font-weight: 600;">Grand Total (All Items, All Suppliers)</span>
        <span style="color: white; font-size: 18px; font-weight: 700;">{{ grand_total|floatformat:0 }} units</span>
      </div>
    </div>
  </div>

  <script>
    // Filter functionality
    const supplierFilter = document.getElementById('supplier-filter');
    const itemFilter = document.getElementById('item-filter');
    const clearFiltersBtn = document.getElementById('clear-filters');
    
    function applyFilters() {
      const supplier = supplierFilter.value;
      const item = itemFilter.value;
      
      const params = new URLSearchParams();
      if (supplier) params.append('supplier', supplier);
      if (item) params.append('item', item);
      
      window.location.href = '{% url "supplier_stock" %}' + (params.toString() ? '?' + params.toString() : '');
    }
    
    supplierFilter.addEventListener('change', applyFilters);
    itemFilter.addEventListener('change', applyFilters);
    
    clearFiltersBtn.addEventListener('click', function() {
      window.location.href = '{% url "supplier_stock" %}';
    });
    
    // Search functionality
    const searchInput = document.querySelector('.table-search-input');
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('.inventory-row');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  </script>
{% endblock %}
