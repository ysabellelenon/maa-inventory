{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
<link rel="stylesheet" href="{% static 'css/requests.css' %}">
<style>
body.view-request-page-open .content {
  height: auto !important;
  overflow: visible !important;
  min-height: calc(100vh - 64px);
  padding-bottom: 40px;
}
body.view-request-page-open .inventory-container {
  height: auto !important;
  overflow: visible !important;
  min-height: auto;
  font-size: 13px;
}
body.view-request-page-open {
  overflow-y: auto;
  overflow-x: hidden;
}
.info-card {
  background: white;
  border: 1px solid #E5E7EB;
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 24px;
}
.info-card h3 {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: #101828;
  border-bottom: 2px solid #D9BD7D;
  padding-bottom: 8px;
}
.info-row {
  display: flex;
  padding: 12px 0;
  border-bottom: 1px solid #F3F4F6;
}
.info-row:last-child {
  border-bottom: none;
}
.info-label {
  font-weight: 500;
  color: #6B7280;
  width: 200px;
  flex-shrink: 0;
}
.info-value {
  color: #101828;
  flex: 1;
}
.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 24px;
}
.items-table th {
  background: #F9FAFB;
  padding: 12px;
  text-align: left;
  font-weight: 600;
  color: #374151;
  border-bottom: 2px solid #E5E7EB;
}
.items-table td {
  padding: 12px;
  border-bottom: 1px solid #F3F4F6;
}
.items-table tr:hover {
  background: #F9FAFB;
}
.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.status-pending { background: #FEF3C7; color: #92400E; }
.status-approved { background: #D1FAE5; color: #065F46; }
.status-rejected { background: #FEE2E2; color: #991B1B; }
.rejection-reason-banner {
  background: #FEE2E2;
  color: #991B1B;
  border: 1px solid #FECACA;
  border-radius: 8px;
  padding: 16px 24px;
  margin-bottom: 24px;
  font-size: 14px;
  line-height: 1.5;
}
.rejection-reason-banner strong { color: #991B1B; }
.status-warehouseprocessing { background: #FEF3C7; color: #92400E; }
.status-readyfordelivery { background: #E0E7FF; color: #3730A3; }
.status-inprocess { background: #E0E7FF; color: #3730A3; }
.status-outfordelivery { background: #FEF3C7; color: #92400E; }
.status-delivered { background: #D1FAE5; color: #065F46; }
.status-completed { background: #D1FAE5; color: #065F46; }
.warehouse-note {
  background: #EFF6FF;
  border: 1px solid #93C5FD;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  font-size: 14px;
  color: #1E40AF;
}
/* Item thumb in Request Items table - same as branch requests page */
.items-table tbody .col-item-name {
  vertical-align: middle;
}
.items-table tbody .item-thumb {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  background: #fff;
  border: 1px solid #f2f2f2;
  object-fit: cover;
  flex: 0 0 36px;
  margin-right: 12px;
  vertical-align: middle;
  cursor: pointer;
  display: inline-block;
}
.items-table tbody .item-meta {
  display: inline-block;
  vertical-align: middle;
  max-width: calc(100% - 52px);
}
.items-table tbody .item-meta .item-title {
  font-weight: 500;
  color: #374151;
  white-space: normal;
  overflow-wrap: break-word;
  word-break: break-word;
}
/* Image lightbox */
#view-request-image-lightbox {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: rgba(0, 0, 0, 0.75);
  align-items: center;
  justify-content: center;
  padding: 24px;
  box-sizing: border-box;
}
#view-request-image-lightbox.is-open {
  display: flex;
}
#view-request-image-lightbox .lightbox-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
  border-radius: 8px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
#view-request-image-lightbox .lightbox-close:hover {
  background: rgba(255, 255, 255, 0.25);
}
#view-request-image-lightbox .lightbox-image {
  max-width: 90vw;
  max-height: 85vh;
  width: auto;
  height: auto;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}
/* Reject reason modal - extends modal-confirm with textarea and label */
#reject-reason-modal .reject-reason-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  font-size: 14px;
  color: var(--text);
}
#reject-reason-modal .reject-reason-textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  font-family: var(--font-stack);
  resize: vertical;
  min-height: 80px;
  box-sizing: border-box;
}
#reject-reason-modal .reject-reason-textarea:focus {
  border-color: var(--focus);
  outline: none;
}
#reject-reason-modal .reject-reason-error {
  margin-top: 6px;
  font-size: 13px;
  color: #991b1b;
  display: none;
}
#reject-reason-modal .reject-reason-error.is-visible {
  display: block;
}
#reject-reason-modal .reject-reason-required {
  color: #991b1b;
}
#reject-reason-modal .reject-reason-buttons {
  margin-top: 20px;
}
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('view-request-page-open');
  });
</script>
{% endblock %}

{% block content %}
  <div class="page-header inventory-header">
    <div style="display:flex;flex-direction:column;">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href="{% url 'dashboard' %}">Dashboard</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <a href="{% url 'requests' %}">Branch Stock Requests</a><span class="sep" aria-hidden="true">&rsaquo;</span>
        <span class="active" aria-current="page">{{ req.request_code }}</span>
      </nav>
      <h2 style="margin-top:6px;">Request: {{ req.request_code }}</h2>
      <h3 class="item-submeta">
        <strong>Status:</strong>
        <span class="status-badge status-{{ req.status|lower }}">{{ req.get_status_display }}</span>
        &nbsp;•&nbsp;
        <strong>Branch:</strong> {{ req.branch.name }}
        &nbsp;•&nbsp;
        <strong>Date:</strong> {{ req.date_of_order|date:"F d, Y" }}
      </h3>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      {% if can_approve %}
      <button id="approve-btn" type="button" class="btn-green">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
        Approve
      </button>
      <button id="reject-btn" type="button" class="btn-red">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        Reject
      </button>
      {% endif %}
      {% if can_start_fulfillment %}
      <button id="mark-in-process-btn" type="button" class="btn-green">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 4 0h8a2 2 0 0 0 4 0V8"/><path d="M14 6h4l4 4v6"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
        Ready for Delivery
      </button>
      {% endif %}
      {% if can_mark_out_for_delivery %}
      <button id="mark-out-for-delivery-btn" type="button" class="btn-green">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 4 0h8a2 2 0 0 0 4 0V8"/><path d="M14 6h4l4 4v6"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
        Out for Delivery
      </button>
      {% endif %}
      {% if can_mark_delivered %}
      <button id="mark-delivered-btn" type="button" class="btn-green">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
        Mark as Delivered
      </button>
      {% endif %}
      <a href="{% url 'requests' %}" class="btn-back">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back to Requests
      </a>
    </div>
  </div>

  <div class="inventory-container">
    <div class="inventory-card">
      {% if can_start_fulfillment %}
      <div class="warehouse-note">
        <strong>Warehouse:</strong> Click &quot;Ready for Delivery&quot; to deduct items from warehouse stock and set this request to Ready for Delivery. The branch manager for <strong>{{ req.branch.name }}</strong> will then mark it as Delivered when items arrive; delivered items will appear on the <a href="{% url 'branches' %}">Branches</a> page for this branch.
      </div>
      {% endif %}
      {% if can_mark_delivered %}
      <div class="warehouse-note">
        <strong>Branch manager:</strong> Confirm that items have been delivered to <strong>{{ req.branch.name }}</strong>. Once you mark as Delivered, these items will appear on the <a href="{% url 'branches' %}">Branches</a> page for your branch.
      </div>
      {% endif %}

      {% if req.status == 'Rejected' and req.rejected_reason %}
      <div class="rejection-reason-banner">
        <strong>Rejection reason:</strong> {{ req.rejected_reason }}
      </div>
      {% endif %}

      <!-- Request Information -->
      <div class="info-card">
        <h3>Request Information</h3>
        <div class="info-row">
          <div class="info-label">Request Code</div>
          <div class="info-value"><strong>{{ req.request_code }}</strong></div>
        </div>
        <div class="info-row">
          <div class="info-label">Status</div>
          <div class="info-value">
            <span class="status-badge status-{{ req.status|lower }}">{{ req.get_status_display }}</span>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Branch</div>
          <div class="info-value">{{ req.branch.name }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Requested By</div>
          <div class="info-value">{{ requestor }}</div>
        </div>
        <div class="info-row">
          <div class="info-label">Order Date</div>
          <div class="info-value">{{ req.date_of_order|date:"F d, Y, g:i A" }}</div>
        </div>
        {% if req.approved_by and approved_by_name %}
        <div class="info-row">
          <div class="info-label">Approved By</div>
          <div class="info-value">{{ approved_by_name }}</div>
        </div>
        {% endif %}
        {% if req.approved_at %}
        <div class="info-row">
          <div class="info-label">Approved At</div>
          <div class="info-value">{{ req.approved_at|date:"F d, Y, g:i A" }}</div>
        </div>
        {% endif %}
        <div class="info-row">
          <div class="info-label">Last Updated</div>
          <div class="info-value">{{ req.updated_at|date:"F d, Y, g:i A" }}</div>
        </div>
      </div>

      <!-- Request Items -->
      <div class="info-card">
        <h3>Request Items ({{ items|length }})</h3>
        <table class="items-table">
          <thead>
            <tr>
              <th>Item Code</th>
              <th>Item Name</th>
              <th>Variation</th>
              <th style="text-align: right;">Requested</th>
              <th style="text-align: right;">Approved</th>
              <th style="text-align: right;">Fulfilled</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
            <tr>
              <td><strong>{{ row.item.item_code }}</strong></td>
              <td class="col-item-name">
                {% if row.image_url %}
                <img class="item-thumb item-thumb-openable" src="{{ row.image_url }}" alt="{{ row.item.name }}" title="Click to enlarge" />
                {% else %}
                <img class="item-thumb item-thumb-openable" src="{% static 'images/sample-item.jpg' %}" alt="{{ row.item.name }}" title="Click to enlarge" />
                {% endif %}
                <div class="item-meta">
                  <div class="item-title">{{ row.item.name }}</div>
                </div>
              </td>
              <td>{% if row.variation %}{{ row.variation.variation_name }}{% else %}—{% endif %}</td>
              <td style="text-align: right;">{{ row.qty_requested|floatformat:0 }}</td>
              <td style="text-align: right;">{{ row.qty_approved|default:"—" }}</td>
              <td style="text-align: right;">{{ row.qty_fulfilled|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #6B7280;">
                No items in this request.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Image lightbox: click item thumb to view full size -->
  <div id="view-request-image-lightbox" role="dialog" aria-modal="true" aria-label="Enlarged image">
    <button type="button" class="lightbox-close" aria-label="Close">&times;</button>
    <img class="lightbox-image" src="" alt="" />
  </div>

  <script>
  (function () {
    var table = document.querySelector('.items-table');
    var lightbox = document.getElementById('view-request-image-lightbox');
    var lightboxImg = lightbox && lightbox.querySelector('.lightbox-image');
    var lightboxClose = lightbox && lightbox.querySelector('.lightbox-close');
    if (table && lightbox && lightboxImg) {
      table.addEventListener('click', function (e) {
        var thumb = e.target.closest && e.target.closest('.item-thumb-openable');
        if (!thumb) return;
        e.preventDefault();
        e.stopPropagation();
        lightboxImg.src = thumb.getAttribute('src') || '';
        lightboxImg.alt = thumb.getAttribute('alt') || 'Item image';
        lightbox.classList.add('is-open');
        lightbox.setAttribute('aria-hidden', 'false');
      }, true);
      function closeLightbox() {
        lightbox.classList.remove('is-open');
        lightbox.setAttribute('aria-hidden', 'true');
      }
      if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
      lightbox.addEventListener('click', function (e) {
        if (e.target === lightbox) closeLightbox();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && lightbox.classList.contains('is-open')) closeLightbox();
      });
    }
  })();
  </script>

  {% if can_approve %}
  <!-- Reject reason modal (uses modal-confirm from base.html) -->
  <div id="reject-reason-modal" class="modal-confirm" role="dialog" aria-modal="true" aria-labelledby="reject-reason-title">
    <div class="modal-confirm-card">
      <h3 id="reject-reason-title" class="modal-confirm-title">Reject Request</h3>
      <label for="reject-reason-textarea" class="reject-reason-label">Reason for rejection <span class="reject-reason-required">*</span></label>
      <textarea id="reject-reason-textarea" class="reject-reason-textarea" placeholder="Enter the reason for rejecting this request..." aria-required="true"></textarea>
      <div id="reject-reason-error" class="reject-reason-error" aria-live="polite">Rejection reason is required.</div>
      <div class="modal-confirm-buttons reject-reason-buttons">
        <button type="button" class="modal-confirm-btn modal-confirm-btn-cancel" id="reject-reason-cancel">Cancel</button>
        <button type="button" class="modal-confirm-btn modal-confirm-btn-confirm modal-confirm-btn-reject" id="reject-reason-submit">Reject</button>
      </div>
    </div>
  </div>

  <!-- Approve/Reject confirmation modal (uses reusable modal-confirm class from base.html) -->
  <div id="approve-reject-confirm-modal" class="modal-confirm" role="dialog" aria-modal="true" aria-labelledby="confirm-modal-title" aria-describedby="confirm-modal-message">
    <div class="modal-confirm-card">
      <h3 id="confirm-modal-title" class="modal-confirm-title"></h3>
      <p id="confirm-modal-message" class="modal-confirm-message"></p>
      <div class="modal-confirm-buttons">
        <button type="button" class="modal-confirm-btn modal-confirm-btn-cancel" id="confirm-modal-cancel">Cancel</button>
        <button type="button" class="modal-confirm-btn modal-confirm-btn-confirm" id="confirm-modal-confirm"></button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        return parts.length === 2 ? parts.pop().split(';').shift() : '';
      }
      function postAction(action, rejectedReason) {
        var body = { action: action };
        if (action === 'reject' && rejectedReason) body.rejected_reason = rejectedReason;
        return fetch('{% url "approve_reject_request" req.id %}', {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        }).then(function(r) { return r.json(); });
      }

      var modal = document.getElementById('approve-reject-confirm-modal');
      var titleEl = document.getElementById('confirm-modal-title');
      var messageEl = document.getElementById('confirm-modal-message');
      var cancelBtn = document.getElementById('confirm-modal-cancel');
      var confirmBtn = document.getElementById('confirm-modal-confirm');

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
      }

      function showConfirmModal(opts) {
        titleEl.textContent = opts.title || 'Confirm';
        messageEl.textContent = opts.message || '';
        confirmBtn.textContent = opts.confirmText || 'Confirm';
        confirmBtn.className = 'modal-confirm-btn modal-confirm-btn-confirm ' + (opts.confirmClass || 'modal-confirm-btn-approve');
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');

        var onConfirm = opts.onConfirm || function() {};
        var onCancel = opts.onCancel || function() {};

        function handleConfirm() {
          closeModal();
          onConfirm();
        }
        function handleCancel() {
          closeModal();
          onCancel();
        }

        confirmBtn.onclick = handleConfirm;
        cancelBtn.onclick = handleCancel;
        modal.onclick = function(e) {
          if (e.target === modal) handleCancel();
        };
        document.addEventListener('keydown', function escHandler(e) {
          if (e.key === 'Escape' && modal.classList.contains('is-open')) {
            document.removeEventListener('keydown', escHandler);
            handleCancel();
          }
        });
      }

      document.getElementById('approve-btn').addEventListener('click', function() {
        var btn = this;
        showConfirmModal({
          title: 'Approve Request',
          message: 'Are you sure you want to approve this request?',
          confirmText: 'Approve',
          confirmClass: 'modal-confirm-btn-approve',
          onConfirm: function() {
            btn.disabled = true;
            btn.innerHTML = '<span>Processing...</span>';
            postAction('approve').then(function(data) {
              if (data.success) { window.location.reload(); }
              else { alert('Error: ' + (data.error || 'Unknown error')); btn.disabled = false; btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Approve'; }
            }).catch(function(err) { alert('Error processing request'); btn.disabled = false; btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Approve'; });
          }
        });
      });

      var rejectReasonModal = document.getElementById('reject-reason-modal');
      var rejectReasonTextarea = document.getElementById('reject-reason-textarea');
      var rejectReasonError = document.getElementById('reject-reason-error');
      var rejectReasonCancel = document.getElementById('reject-reason-cancel');
      var rejectReasonSubmit = document.getElementById('reject-reason-submit');
      var rejectBtn = document.getElementById('reject-btn');

      function closeRejectReasonModal() {
        rejectReasonModal.classList.remove('is-open');
        rejectReasonModal.setAttribute('aria-hidden', 'true');
        rejectReasonTextarea.value = '';
        rejectReasonError.classList.remove('is-visible');
      }

      document.getElementById('reject-btn').addEventListener('click', function() {
        rejectReasonTextarea.value = '';
        rejectReasonError.classList.remove('is-visible');
        rejectReasonModal.classList.add('is-open');
        rejectReasonModal.setAttribute('aria-hidden', 'false');
        rejectReasonTextarea.focus();
      });

      rejectReasonCancel.addEventListener('click', closeRejectReasonModal);
      rejectReasonModal.addEventListener('click', function(e) {
        if (e.target === rejectReasonModal) closeRejectReasonModal();
      });

      rejectReasonSubmit.addEventListener('click', function() {
        var reason = (rejectReasonTextarea.value || '').trim();
        if (!reason) {
          rejectReasonError.classList.add('is-visible');
          rejectReasonTextarea.focus();
          return;
        }
        rejectReasonError.classList.remove('is-visible');
        closeRejectReasonModal();
        showConfirmModal({
          title: 'Reject Request',
          message: 'Are you sure you want to reject this request with the following reason?\n\n' + reason,
          confirmText: 'Reject',
          confirmClass: 'modal-confirm-btn-reject',
          onConfirm: function() {
            rejectBtn.disabled = true;
            rejectBtn.innerHTML = '<span>Processing...</span>';
            postAction('reject', reason).then(function(data) {
              if (data.success) { window.location.reload(); }
              else { alert('Error: ' + (data.error || 'Unknown error')); rejectBtn.disabled = false; rejectBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg> Reject'; }
            }).catch(function(err) { alert('Error processing request'); rejectBtn.disabled = false; rejectBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg> Reject'; });
          }
        });
      });

      document.addEventListener('keydown', function rejectReasonEscHandler(e) {
        if (e.key === 'Escape' && rejectReasonModal.classList.contains('is-open')) {
          closeRejectReasonModal();
        }
      });
    })();
  </script>
  {% endif %}

  {% if can_start_fulfillment %}
  <div id="ready-for-delivery-confirm-modal" class="modal-confirm" role="dialog" aria-modal="true" aria-labelledby="ready-for-delivery-modal-title" aria-describedby="ready-for-delivery-modal-message">
    <div class="modal-confirm-card">
      <h3 id="ready-for-delivery-modal-title" class="modal-confirm-title">Ready for Delivery</h3>
      <p id="ready-for-delivery-modal-message" class="modal-confirm-message">Are you sure you want to mark this request as Ready for Delivery?<br><br>This will deduct the items from warehouse stock and move this request to Ready for Delivery for the logistics team.</p>
      <div class="modal-confirm-buttons">
        <button type="button" class="modal-confirm-btn modal-confirm-btn-cancel" id="ready-for-delivery-modal-cancel">Cancel</button>
        <button type="button" class="modal-confirm-btn modal-confirm-btn-confirm modal-confirm-btn-approve" id="ready-for-delivery-modal-confirm">Ready for Delivery</button>
      </div>
    </div>
  </div>
  <script>
    (function() {
      function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      var btn = document.getElementById('mark-in-process-btn');
      var modal = document.getElementById('ready-for-delivery-confirm-modal');
      var cancelBtn = document.getElementById('ready-for-delivery-modal-cancel');
      var confirmBtn = document.getElementById('ready-for-delivery-modal-confirm');

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
      }

      if (btn && modal) {
        btn.addEventListener('click', function() {
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        });

        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
        });

        confirmBtn.addEventListener('click', function() {
          closeModal();
          var originalHtml = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span>Processing...</span>';
          fetch('{% url "mark_request_in_process" req.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) { window.location.reload(); }
            else { alert('Error: ' + (data.error || 'Unknown error')); btn.disabled = false; btn.innerHTML = originalHtml; }
          })
          .catch(function(err) { alert('Error processing request'); btn.disabled = false; btn.innerHTML = originalHtml; });
        });
      }
    })();
  </script>
  {% endif %}

  {% if can_mark_out_for_delivery %}
  <div id="out-for-delivery-confirm-modal" class="modal-confirm" role="dialog" aria-modal="true" aria-labelledby="out-for-delivery-modal-title" aria-describedby="out-for-delivery-modal-message">
    <div class="modal-confirm-card">
      <h3 id="out-for-delivery-modal-title" class="modal-confirm-title">Out for Delivery</h3>
      <p id="out-for-delivery-modal-message" class="modal-confirm-message">Are you sure you want to mark this request as Out for Delivery? The branch manager can then mark it as Delivered when items arrive.</p>
      <div class="modal-confirm-buttons">
        <button type="button" class="modal-confirm-btn modal-confirm-btn-cancel" id="out-for-delivery-modal-cancel">Cancel</button>
        <button type="button" class="modal-confirm-btn modal-confirm-btn-confirm modal-confirm-btn-approve" id="out-for-delivery-modal-confirm">Out for Delivery</button>
      </div>
    </div>
  </div>
  <script>
    (function() {
      function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      var btn = document.getElementById('mark-out-for-delivery-btn');
      var modal = document.getElementById('out-for-delivery-confirm-modal');
      var cancelBtn = document.getElementById('out-for-delivery-modal-cancel');
      var confirmBtn = document.getElementById('out-for-delivery-modal-confirm');

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
      }

      if (btn && modal) {
        btn.addEventListener('click', function() {
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        });

        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
        });

        confirmBtn.addEventListener('click', function() {
          closeModal();
          var originalHtml = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span>Processing...</span>';
          fetch('{% url "mark_request_out_for_delivery" req.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) { window.location.reload(); }
            else { alert('Error: ' + (data.error || 'Unknown error')); btn.disabled = false; btn.innerHTML = originalHtml; }
          })
          .catch(function(err) { alert('Error processing request'); btn.disabled = false; btn.innerHTML = originalHtml; });
        });
      }
    })();
  </script>
  {% endif %}

  {% if can_mark_delivered %}
  <div id="mark-delivered-confirm-modal" class="modal-confirm" role="dialog" aria-modal="true" aria-labelledby="mark-delivered-modal-title" aria-describedby="mark-delivered-modal-message">
    <div class="modal-confirm-card">
      <h3 id="mark-delivered-modal-title" class="modal-confirm-title">Mark as Delivered</h3>
      <p id="mark-delivered-modal-message" class="modal-confirm-message">Confirm that items have been delivered to your branch? They will then appear on the Branches page for {{ req.branch.name }}.</p>
      <div class="modal-confirm-buttons">
        <button type="button" class="modal-confirm-btn modal-confirm-btn-cancel" id="mark-delivered-modal-cancel">Cancel</button>
        <button type="button" class="modal-confirm-btn modal-confirm-btn-confirm modal-confirm-btn-approve" id="mark-delivered-modal-confirm">Mark as Delivered</button>
      </div>
    </div>
  </div>
  <script>
    (function() {
      function getCookie(name) {
        var value = '; ' + document.cookie;
        var parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      var btn = document.getElementById('mark-delivered-btn');
      var modal = document.getElementById('mark-delivered-confirm-modal');
      var cancelBtn = document.getElementById('mark-delivered-modal-cancel');
      var confirmBtn = document.getElementById('mark-delivered-modal-confirm');

      function closeModal() {
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
      }

      if (btn && modal) {
        btn.addEventListener('click', function() {
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
        });

        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeModal();
        });
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
        });

        confirmBtn.addEventListener('click', function() {
          closeModal();
          var originalHtml = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span>Processing...</span>';
          fetch('{% url "mark_request_delivered" req.id %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.success) { window.location.reload(); }
            else { alert('Error: ' + (data.error || 'Unknown error')); btn.disabled = false; btn.innerHTML = originalHtml; }
          })
          .catch(function(err) { alert('Error processing request'); btn.disabled = false; btn.innerHTML = originalHtml; });
        });
      }
    })();
  </script>
  {% endif %}
{% endblock %}
