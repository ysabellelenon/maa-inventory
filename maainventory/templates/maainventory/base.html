{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Management</title>
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  {% block extra_css %}{% endblock %}
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .alert-message {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Auto-hide messages after 5 seconds */
    .alert-message {
      animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 4.5s forwards;
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .btn-gold {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      background: var(--focus);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
      border: 1px solid var(--focus);
      font-family: inherit;
    }
    .btn-gold:hover {
      background: var(--focus);
      color: white;
    }
    .btn-gold img {
      width: 16px;
      height: 16px;
      filter: brightness(0) invert(1);
    }

    .btn-green {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      background: #16a34a;
      color: white;
      border: 1px solid #15803d;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
    .btn-green:hover {
      background: #15803d;
      border-color: #166534;
    }
    .btn-green img {
      width: 16px;
      height: 16px;
      filter: brightness(0) invert(1);
    }
    .btn-cancel {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 24px;
      background: var(--accent);
      color: var(--text);
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      border: 1px solid var(--border);
      font-family: inherit;
    }
    .btn-cancel-icon {
      width: 16px;
      height: 16px;
    }
    /* Empty state message: same text style as table empty messages (e.g. "No branches available", "No inventory items...") */
    .empty-state-message {
      font-size: 13px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar-overlay" aria-hidden="true"></div>
    <aside class="sidebar">
      <div class="sidebar-header">
        <button type="button" class="drawer-close" aria-label="Close menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="sidebar-toggle" role="button" tabindex="0" aria-pressed="false">
        <img src="{% static 'icons/chevron-left.svg' %}" data-alt-src="{% static 'icons/chevron-right.svg' %}" alt="Collapse sidebar" />
      </div>
      <div class="brand">
      </div>

      <nav class="nav">
        <a class="nav-item {% if request.path == '/' %}active{% endif %}" href="{% url 'dashboard' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          <span>Dashboard</span>
        </a>
        {% if not is_branch_user %}
        <a class="nav-item {% if request.path == '/inventory/' %}active{% endif %}" href="{% url 'inventory' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"/><path d="M12 22V12"/><polyline points="3.29 7 12 12 20.71 7"/><path d="m7.5 4.27 9 5.15"/></svg>
          <span>Warehouse Inventory</span>
        </a>
        {% endif %}
        <div class="nav-group {% if request.path == '/requests/' or '/item-requests/' in request.path %}expanded{% endif %}" data-nav-group="requests">
          <button type="button" class="nav-item nav-group-toggle {% if request.path == '/requests/' or '/item-requests/' in request.path %}active{% endif %}" aria-expanded="{% if request.path == '/requests/' or '/item-requests/' in request.path %}true{% else %}false{% endif %}" aria-controls="nav-sub-requests" id="nav-toggle-requests">
            <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18.226 5.226-2.52-2.52A2.4 2.4 0 0 0 14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-.351"/><path d="M21.378 12.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/><path d="M8 18h1"/></svg>
            <span>Requests</span>
            <img class="nav-chevron" src="{% static 'icons/chevron-down.svg' %}" alt="" aria-hidden="true" />
          </button>
          <div class="nav-sub" id="nav-sub-requests" role="region" aria-label="Requests submenu" {% if request.path == '/requests/' or '/item-requests/' in request.path %}style="display:block"{% endif %}>
            <a class="nav-sub-item {% if request.path == '/requests/' %}active{% endif %}" href="{% url 'requests' %}">Branch Request</a>
            {% if not is_branch_user and not is_warehouse_staff %}
            <a class="nav-sub-item {% if '/item-requests/' in request.path %}active{% endif %}" href="{% url 'item_requests' %}">Item Requests</a>
            {% endif %}
          </div>
        </div>
        {% if not is_branch_user %}
        {% if is_warehouse_staff %}
        <a class="nav-item {% if request.path == '/purchase-orders/' %}active{% endif %}" href="{% url 'purchase_orders' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
          <span>Purchase Orders</span>
        </a>
        <a class="nav-item {% if '/branches/' in request.path %}active{% endif %}" href="{% url 'branches' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
          <span>Branches</span>
        </a>
        {% endif %}
        {% if not is_warehouse_staff %}
        <a class="nav-item {% if request.path == '/supplier-stock/' %}active{% endif %}" href="{% url 'supplier_stock' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
          <span>Supplier Stock</span>
        </a>
        <a class="nav-item {% if request.path == '/suppliers/' %}active{% endif %}" href="{% url 'suppliers' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12h.01"/><path d="M16 6V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 0l-2 2"/><path d="M22 13a18.15 18.15 0 0 1-20 0"/><rect width="20" height="14" x="2" y="6" rx="2"/></svg>
          <span>Suppliers</span>
        </a>
        <a class="nav-item {% if '/branches/' in request.path %}active{% endif %}" href="{% url 'branches' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
          <span>Branches</span>
        </a>
        {% if is_procurement_user or is_it_user %}
        <a class="nav-item {% if '/branch-assignments/' in request.path %}active{% endif %}" href="{% url 'manage_branch_assignments' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/></svg>
          <span>Branch Assignments</span>
        </a>
        {% endif %}
        <a class="nav-item {% if request.path == '/reports/' %}active{% endif %}" href="{% url 'reports' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/><path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/><path d="M4 18v3"/><path d="M8 14v7"/></svg>
          <span>Reports</span>
        </a>
        {% endif %}
        {% else %}
        <a class="nav-item {% if '/branches/' in request.path %}active{% endif %}" href="{% url 'branches' %}">
          <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
          <span>Branches</span>
        </a>
        {% endif %}
      </nav>

      <div class="logout">
        <a href="{% url 'logout' %}" class="nav-item logout-item">
          <img src="{% static 'icons/log-out.svg' %}" alt="Logout" />
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <div id="nav-requests-popover" class="nav-popover" role="menu" aria-label="Requests menu" hidden>
      <a class="nav-popover-item {% if request.path == '/requests/' %}active{% endif %}" href="{% url 'requests' %}">Branch Request</a>
      {% if not is_branch_user and not is_warehouse_staff %}
      <a class="nav-popover-item {% if '/item-requests/' in request.path %}active{% endif %}" href="{% url 'item_requests' %}">Item Requests</a>
      {% endif %}
    </div>

    <main class="main">
      <header class="topbar">
        <div class="brand-top">
          <button type="button" class="navbar-hamburger" aria-label="Open menu" aria-expanded="false">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
          </button>
          <img src="{% static 'images/MAA-logo-transparent.png' %}" alt="MAA logo" class="brand-logo" />
          <span class="brand-text">Inventory Management</span>
        </div>
        <div class="search">
          <img src="{% static 'icons/search.svg' %}" alt="search" class="search-icon" />
          <input placeholder="Search by item name or supplier name" />
        </div>
        <div class="top-actions">
          <span class="icon-badge">
            <img class="icon" src="{% static 'icons/bell.svg' %}" alt="notifications" />
          </span>
          <div class="user">
            <div class="user-name">
              {% if user.is_authenticated %}
                {% if user.profile.full_name %}
                  {{ user.profile.full_name }}
                {% elif user.get_full_name %}
                  {{ user.get_full_name }}
                {% else %}
                  {{ user.username }}
                {% endif %}
              {% else %}
                Guest
              {% endif %}
            </div>
            <div class="user-role">
              {% if user.is_authenticated %}
                {% if user.profile.punch_id %}
                  {{ user.profile.punch_id }}
                {% endif %}
                {% if user.profile.role %}
                  {% if user.profile.punch_id %} â€¢ {% endif %}{{ user.profile.role.name }}
                {% elif not user.profile.punch_id %}
                  MAA Employee
                {% endif %}
              {% else %}
                Not logged in
              {% endif %}
            </div>
          </div>
        </div>
      </header>

      <section class="content">
        {% if messages %}
          <div style="position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;">
            {% for message in messages %}
              <div class="alert-message alert-{{ message.tags }}" style="padding: 14px 18px; margin-bottom: 12px; border-radius: 8px; background: {% if message.tags == 'error' %}#fee2e2{% elif message.tags == 'success' %}#dcfce7{% elif message.tags == 'warning' %}#fef3c7{% else %}#dbeafe{% endif %}; color: {% if message.tags == 'error' %}#991b1b{% elif message.tags == 'success' %}#166534{% elif message.tags == 'warning' %}#92400e{% else %}#1e40af{% endif %}; border: 1px solid {% if message.tags == 'error' %}#fecaca{% elif message.tags == 'success' %}#bbf7d0{% elif message.tags == 'warning' %}#fde68a{% else %}#bfdbfe{% endif %}; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); display: flex; align-items: center; justify-content: space-between; gap: 12px; animation: slideIn 0.3s ease-out;">
                <span style="flex: 1;">{{ message }}</span>
                <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: inherit; cursor: pointer; opacity: 0.7; font-size: 20px; line-height: 1; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">&times;</button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        
        {% block content %}{% endblock %}
      </section>
    </main>
  </div>
  <script>
    (function () {
      var toggle = document.querySelector('.sidebar-toggle');
      if (!toggle) return;
      var sidebar = document.querySelector('.sidebar');
      var img = toggle.querySelector('img');
      var altSrc = img && img.getAttribute('data-alt-src');
      var STORAGE_KEY = 'sidebarCollapsed';

      function applyCollapsed() {
        sidebar.classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
        if (img && altSrc) {
          var current = img.getAttribute('src');
          img.setAttribute('src', altSrc);
          img.setAttribute('data-alt-src', current);
        } else if (img) {
          img.style.transform = 'rotate(180deg)';
        }
        toggle.setAttribute('aria-pressed', 'true');
      }

      try {
        if (localStorage.getItem(STORAGE_KEY) === 'true') applyCollapsed();
      } catch (e) {}

      toggle.addEventListener('click', function () {
        var collapsed = sidebar.classList.toggle('collapsed');
        document.body.classList.toggle('sidebar-collapsed', collapsed);
        if (img && altSrc) {
          var current = img.getAttribute('src');
          img.setAttribute('src', altSrc);
          img.setAttribute('data-alt-src', current);
        } else if (img) {
          img.style.transform = collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        toggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
        try { localStorage.setItem(STORAGE_KEY, collapsed ? 'true' : 'false'); } catch (e) {}
      });
    })();

    (function () {
      var hamburger = document.querySelector('.navbar-hamburger');
      var overlay = document.querySelector('.sidebar-overlay');
      var drawerClose = document.querySelector('.drawer-close');
      var sidebar = document.querySelector('.sidebar');
      if (!hamburger || !overlay) return;

      function openMenu() {
        document.body.classList.add('menu-open');
        hamburger.setAttribute('aria-expanded', 'true');
        if (overlay) overlay.setAttribute('aria-hidden', 'false');
      }
      function closeMenu() {
        document.body.classList.remove('menu-open');
        hamburger.setAttribute('aria-expanded', 'false');
        if (overlay) overlay.setAttribute('aria-hidden', 'true');
      }

      hamburger.addEventListener('click', openMenu);
      overlay.addEventListener('click', closeMenu);
      if (drawerClose) drawerClose.addEventListener('click', closeMenu);
      if (sidebar) {
        sidebar.querySelectorAll('.nav-item:not(.nav-group-toggle)').forEach(function (link) {
          link.addEventListener('click', closeMenu);
        });
        sidebar.querySelectorAll('.nav-sub-item').forEach(function (link) {
          link.addEventListener('click', closeMenu);
        });
      }
    })();

    (function () {
      var toggle = document.getElementById('nav-toggle-requests');
      var group = toggle && toggle.closest('.nav-group');
      var sub = document.getElementById('nav-sub-requests');
      var popover = document.getElementById('nav-requests-popover');
      var sidebar = document.querySelector('.sidebar');
      if (!toggle || !group || !sub) return;

      function closePopover() {
        if (popover) {
          popover.classList.remove('open');
          popover.setAttribute('hidden', '');
        }
      }

      function openPopover() {
        if (!popover || !sidebar.classList.contains('collapsed')) return;
        var rect = toggle.getBoundingClientRect();
        popover.style.top = rect.top + 'px';
        popover.style.left = (rect.right + 8) + 'px';
        popover.classList.add('open');
        popover.removeAttribute('hidden');
      }

      toggle.addEventListener('click', function (e) {
        if (sidebar.classList.contains('collapsed')) {
          e.preventDefault();
          e.stopPropagation();
          if (popover && popover.classList.contains('open')) {
            closePopover();
          } else {
            openPopover();
          }
          return;
        }
        var expanded = group.classList.toggle('expanded');
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        sub.style.display = expanded ? 'block' : 'none';
      });

      document.addEventListener('click', function (e) {
        if (!popover || !popover.classList.contains('open')) return;
        if (popover.contains(e.target) || toggle.contains(e.target)) return;
        closePopover();
      });

      if (popover) {
        popover.querySelectorAll('.nav-popover-item').forEach(function (link) {
          link.addEventListener('click', closePopover);
        });
      }
      var collapseToggle = document.querySelector('.sidebar-toggle');
      if (collapseToggle) {
        collapseToggle.addEventListener('click', function () {
          closePopover();
        });
      }
    })();

    
    // Auto-remove alert messages after animation completes
    (function() {
      var alerts = document.querySelectorAll('.alert-message');
      alerts.forEach(function(alert) {
        setTimeout(function() {
          alert.remove();
        }, 5000); // Remove after 5 seconds (matches animation timing)
      });
    })();
  </script>
</body>
</html>


