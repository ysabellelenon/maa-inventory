{% extends "maainventory/base.html" %}
{% load static %}

{% block content %}
  <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h2>Punch ID Management</h2>
    <a href="{% url 'dashboard' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--accent); color: var(--text); text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid var(--border);">
      <img src="{% static 'icons/chevron-left.svg' %}" alt="Back" style="width: 16px; height: 16px;" />
      Back to Dashboard
    </a>
  </div>

  {% if messages %}
    <div style="margin-bottom: 20px;">
      {% for message in messages %}
        <div style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; background: {% if message.tags == 'error' %}#fee2e2{% elif message.tags == 'success' %}#dcfce7{% else %}var(--accent){% endif %}; color: {% if message.tags == 'error' %}#991b1b{% elif message.tags == 'success' %}#166534{% else %}var(--text){% endif %}; border: 1px solid {% if message.tags == 'error' %}#fecaca{% elif message.tags == 'success' %}#bbf7d0{% else %}var(--border){% endif %};">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="panel" style="margin-bottom: 24px;">
    <h3 style="margin-bottom: 16px;">Add New Punch ID</h3>
    <form method="post" action="{% url 'punch_id_add' %}" style="display: flex; gap: 12px; align-items: end;">
      {% csrf_token %}
      <div style="flex: 1;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text);">Punch ID <span style="color: #ef4444;">*</span></label>
        <input type="text" name="punch_id" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: var(--font-stack);" placeholder="Enter Punch ID" />
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <label style="display: flex; align-items: center; gap: 6px; font-weight: 500; color: var(--text); cursor: pointer;">
          <input type="checkbox" name="is_active" checked style="width: 18px; height: 18px; cursor: pointer;" />
          Active
        </label>
        <button type="submit" style="padding: 10px 20px; background: var(--focus); color: white; border: 1px solid var(--focus); border-radius: 8px; font-weight: 500; cursor: pointer; white-space: nowrap;">
          Add
        </button>
      </div>
    </form>
  </div>

  <div class="panel">
    <h3 style="margin-bottom: 16px;">Valid Punch IDs</h3>
    {% if punch_ids %}
      <div class="list">
        {% for punch_id_obj in punch_ids %}
          <div class="list-row">
            <div class="row-content" style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 16px; align-items: center;">
              <div>
                <div style="font-weight: 600; color: var(--text);">{{ punch_id_obj.punch_id }}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                  Created: {{ punch_id_obj.created_at|date:"M d, Y" }}
                  {% if punch_id_obj.punch_id in used_punch_ids %}
                    <span style="color: #16a34a; margin-left: 8px;">● Registered</span>
                  {% else %}
                    <span style="color: var(--muted); margin-left: 8px;">○ Available</span>
                  {% endif %}
                </div>
              </div>
              <div>
                {% if punch_id_obj.is_active %}
                  <span style="display: inline-block; padding: 4px 12px; background: #dcfce7; color: #166534; border-radius: 12px; font-size: 12px; font-weight: 500;">Active</span>
                {% else %}
                  <span style="display: inline-block; padding: 4px 12px; background: #fee2e2; color: #991b1b; border-radius: 12px; font-size: 12px; font-weight: 500;">Inactive</span>
                {% endif %}
              </div>
              <div style="display: flex; gap: 8px;">
                <a href="{% url 'punch_id_edit' punch_id_obj.id %}" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--accent); color: var(--text); text-decoration: none; border-radius: 6px; font-size: 13px; border: 1px solid var(--border);">
                  Edit
                </a>
                {% if punch_id_obj.punch_id not in used_punch_ids %}
                  <form method="post" action="{% url 'punch_id_delete' punch_id_obj.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete Punch ID {{ punch_id_obj.punch_id }}?');">
                    {% csrf_token %}
                    <button type="submit" style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 6px; font-size: 13px; cursor: pointer;">
                      Delete
                    </button>
                  </form>
                {% else %}
                  <span style="display: inline-block; padding: 6px 12px; color: var(--muted); font-size: 13px; cursor: not-allowed;" title="Cannot delete - already registered">Delete</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="list-row">
        <div class="row-content">
          <div class="item-name" style="color: var(--muted);">No Punch IDs added yet. Add one above to get started.</div>
        </div>
      </div>
    {% endif %}
  </div>

  {% if punch_ids %}
    {% with total=punch_ids|length used_count=used_punch_ids|length %}
      {% with available_count=total|add:"-"|add:used_count %}
        <div style="margin-top: 16px; padding: 12px; background: var(--accent); border-radius: 8px; border: 1px solid var(--border);">
          <div style="font-size: 14px; color: var(--text);">
            <strong>Total:</strong> {{ total }} Punch ID{{ total|pluralize }}
            <span style="margin-left: 16px;">
              <strong>Registered:</strong> {{ used_count }}
            </span>
            <span style="margin-left: 16px;">
              <strong>Available:</strong> {{ available_count }}
            </span>
          </div>
        </div>
      {% endwith %}
    {% endwith %}
  {% endif %}

  <style>
    .list-row {
      border-bottom: 1px solid var(--border);
    }
    .list-row:last-child {
      border-bottom: none;
    }
  </style>
{% endblock %}

