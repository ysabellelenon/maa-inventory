{% extends "maainventory/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/requests.css' %}">
<style>
/* Image lightbox: full-size item image */
#image-lightbox {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: rgba(0, 0, 0, 0.75);
  align-items: center;
  justify-content: center;
  padding: 24px;
  box-sizing: border-box;
}
#image-lightbox.is-open {
  display: flex;
}
#image-lightbox .lightbox-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
  border-radius: 8px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
#image-lightbox .lightbox-close:hover {
  background: rgba(255, 255, 255, 0.25);
}
#image-lightbox .lightbox-image {
  max-width: 90vw;
  max-height: 85vh;
  width: auto;
  height: auto;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}
.inventory-table .col-name .item-thumb {
  cursor: pointer;
}
</style>
{% endblock %}

{% block content %}
  <div class="page-header inventory-header">
    <h2>Branch Stock Requests</h2>
    {% if is_branch_manager %}
    <a href="{% url 'create_stock_request' %}" class="btn-create">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      <span>New Request</span>
    </a>
    {% endif %}
  </div>

  <div class="inventory-container">
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-key="all">All <span class="tab-badge">{{ tab_counts.all|default:0 }}</span></button>
        <button class="tab-btn" data-key="new">New <span class="tab-badge">{{ tab_counts.new|default:0 }}</span></button>
        <button class="tab-btn" data-key="pending">Pending <span class="tab-badge">{{ tab_counts.pending|default:0 }}</span></button>
        <button class="tab-btn" data-key="in-process">In Process <span class="tab-badge">0</span></button>
        <button class="tab-btn" data-key="delivered">Delivered <span class="tab-badge">0</span></button>
        <button class="tab-btn" data-key="completed">Completed <span class="tab-badge">0</span></button>
        <button class="tab-btn" data-key="rejected">Rejected <span class="tab-badge">0</span></button>
      </div>
    </div>
    <div class="inventory-card">
      <div class="table-actions">
        <div class="table-actions-left">
          <div class="table-search">
            <img src="{% static 'icons/search.svg' %}" class="table-search-icon" alt="Search" />
            <input class="table-search-input" placeholder="Search by requestor or item" aria-label="Search requests" />
          </div>
          <form method="get" action="{% url 'requests' %}" class="category-filter-form">
            <select id="branch-filter" name="branch" class="category-filter-select" aria-label="Filter by branch" onchange="this.form.submit()">
              <option value="" {% if not current_branch %}selected{% endif %}>All branches</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}" {% if current_branch == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
      <div class="table-wrapper">
      <table class="inventory-table">
        <thead>
          <tr>
            <th class="col-check"><input type="checkbox" class="select-all" aria-label="Select all requests" /></th>
            <th class="col-expand"></th>
            <th class="col-code">Request ID</th>
            <th class="col-requestor">Requestor</th>
            <th class="col-branch">Branch</th>
            <th class="col-name">Item Name</th>
            <th class="col-requested">Requested</th>
            <th class="col-status">Status</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr class="inventory-row {% if item.status == 'LOW' %}row-low{% endif %}" {% if item.is_new %}data-new="true"{% endif %} style="cursor: pointer;" onclick="window.location.href='{% url 'view_request' item.id %}'" onmouseover="this.style.backgroundColor='#F9FAFB'" onmouseout="this.style.backgroundColor=''">
              <td class="col-check" onclick="event.stopPropagation();"><input type="checkbox" class="row-select" aria-label="select request #{{ forloop.counter }}" /></td>
              <td class="col-expand" onclick="event.stopPropagation();">
                <button class="expand" aria-hidden="true">
                  <img class="expand-icon" src="{% static 'icons/chevron-right.svg' %}" alt="" />
                </button>
              </td>
              <td class="col-code">
                <a href="{% url 'view_request' item.id %}" onclick="event.stopPropagation();" style="color: var(--focus); text-decoration: none; font-weight: 600;">
                  {{ item.code }}
                </a>
              </td>
              <td class="col-requestor">{{ item.requestor|default:"—" }}</td>
              <td class="col-branch">{{ item.branch|default:"—" }}</td>
              <td class="col-name">
                <img class="item-thumb item-thumb-openable" src="{% static 'images/sample-item.jpg' %}" alt="{{ item.name|default:'' }}" title="Click to enlarge" />
                <div class="item-meta">
                  <div class="item-title">{{ item.name }}</div>
                </div>
              </td>
              <td class="col-requested">{{ item.requested_date|default:"—" }}</td>
              <td class="col-status">
                {% if item.status == 'Pending' %}
                  <span class="status-pill status-pending">{{ item.status }}</span>
                {% elif item.status == 'Under Review' %}
                  <span class="status-pill status-under-review">{{ item.status }}</span>
                {% elif item.status == 'Approved' %}
                  <span class="status-pill status-approved">{{ item.status }}</span>
                {% elif item.status == 'Rejected' %}
                  <span class="status-pill status-rejected">{{ item.status }}</span>
                {% elif item.status == 'In Process' %}
                  <span class="status-pill status-in-process">{{ item.status }}</span>
                {% elif item.status == 'Out for Delivery' %}
                  <span class="status-pill status-out-for-delivery">{{ item.status }}</span>
                {% elif item.status == 'Delivered' %}
                  <span class="status-pill status-delivered">{{ item.status }}</span>
                {% elif item.status == 'Completed' %}
                  <span class="status-pill status-completed">{{ item.status }}</span>
                {% else %}
                  <span class="status-pill">{{ item.status }}</span>
                {% endif %}
              </td>
              <td class="col-action" onclick="event.stopPropagation();">
                <div class="action-btn-container">
                  <button class="action-btn" aria-label="More actions"
                          data-id="{{ item.id }}"
                          data-code="{{ item.code }}"
                          data-name="{{ item.name|default:'—' }}"
                          data-status="{{ item.status }}">
                    <img src="{% static 'icons/more.svg' %}" alt="More" class="action-icon" />
                  </button>
                </div>
              </td>
            </tr>
            <tr class="inventory-details" hidden>
              <td colspan="9">
                <div class="details-inner">
                  <div class="details-header">Details</div>
                  <div class="details-grid">
                    <div class="detail-item">
                      <div class="detail-label">Foodics</div>
                      <div class="detail-value">{{ item.foodics|default:"123" }}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Talabat</div>
                      <div class="detail-value">{{ item.talabat|default:"45" }}</div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" class="table-empty-message">
                No stock requests yet.{% if is_branch_manager %} <a href="{% url 'create_stock_request' %}" style="color: var(--focus); font-weight: 500;">Create a request</a> to get started.{% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      <div class="table-footer">
        <div class="table-footer-left">
          <label class="show-label">Show
            <select class="page-size" aria-label="Results per page">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span class="entries-info">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
          </span>
        </div>
        <div class="table-footer-right">
          {% if page_obj.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?{% if current_branch %}branch={{ current_branch }}&{% endif %}page={{ page_obj.previous_page_number }}" class="page-prev" aria-label="Previous page">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </a>
            {% else %}
            <span class="page-prev" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-left.svg' %}" alt="Prev" />
            </span>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <span class="page-num active" aria-current="page">{{ num }}</span>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?{% if current_branch %}branch={{ current_branch }}&{% endif %}page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == 1 or num == page_obj.paginator.num_pages %}
                <a href="?{% if current_branch %}branch={{ current_branch }}&{% endif %}page={{ num }}" class="page-num">{{ num }}</a>
              {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                <span class="page-dots">…</span>
              {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?{% if current_branch %}branch={{ current_branch }}&{% endif %}page={{ page_obj.next_page_number }}" class="page-next" aria-label="Next page">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </a>
            {% else %}
            <span class="page-next" style="opacity: 0.5; cursor: not-allowed;">
              <img src="{% static 'icons/chevron-right.svg' %}" alt="Next" />
            </span>
            {% endif %}
          </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

<script>
  (function () {
    var rightIcon = "{% static 'icons/chevron-right.svg' %}";
    var downIcon = "{% static 'icons/chevron-down.svg' %}";
    function toggleRow(button) {
      var row = button.closest('tr');
      if (!row) return;
      var details = row.nextElementSibling;
      var img = button.querySelector('img.expand-icon');
      var expanded = row.classList.toggle('expanded');
      if (details && details.classList.contains('inventory-details')) {
        if (expanded) {
          details.removeAttribute('hidden');
        } else {
          details.setAttribute('hidden', '');
        }
      }
      if (img) {
        img.setAttribute('src', expanded ? downIcon : rightIcon);
      }
      button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }

    document.addEventListener('click', function (e) {
      var btn = e.target.closest && e.target.closest('.expand');
      if (btn) {
        e.preventDefault();
        toggleRow(btn);
      }
    });
  })();
</script>

{{ tab_counts|json_script:"tab-counts-data" }}
<!-- Action menu: Approve/Reject for Procurement on Pending/Under Review, else View -->
<div class="overlay" hidden></div>
<div class="action-menu" hidden role="menu" aria-hidden="true"></div>

<!-- Image lightbox: click item thumb to view full size -->
<div id="image-lightbox" role="dialog" aria-modal="true" aria-label="Enlarged image">
  <button type="button" class="lightbox-close" aria-label="Close">&times;</button>
  <img class="lightbox-image" src="" alt="" />
</div>

<script>
  (function () {
    // Item thumb: click opens lightbox (capture phase so row onclick does not run)
    var table = document.querySelector('.inventory-table');
    var lightbox = document.getElementById('image-lightbox');
    var lightboxImg = lightbox && lightbox.querySelector('.lightbox-image');
    var lightboxClose = lightbox && lightbox.querySelector('.lightbox-close');

    if (table && lightbox && lightboxImg) {
      table.addEventListener('click', function (e) {
        var thumb = e.target.closest && e.target.closest('.item-thumb-openable');
        if (!thumb) return;
        e.preventDefault();
        e.stopPropagation();
        lightboxImg.src = thumb.getAttribute('src') || '';
        lightboxImg.alt = thumb.getAttribute('alt') || 'Item image';
        lightbox.classList.add('is-open');
        lightbox.setAttribute('aria-hidden', 'false');
      }, true);

      function closeLightbox() {
        lightbox.classList.remove('is-open');
        lightbox.setAttribute('aria-hidden', 'true');
      }
      if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
      lightbox.addEventListener('click', function (e) {
        if (e.target === lightbox) closeLightbox();
      });
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && lightbox.classList.contains('is-open')) closeLightbox();
      });
    }
  })();
</script>
<script>
  (function () {
    var actionMenu = document.querySelector('.action-menu');
    var currentActionButton = null;
    var isProcurement = {{ is_procurement_user|yesno:"true,false" }};
    if (!actionMenu) return;

    function getCookie(name) {
      var value = '; ' + document.cookie;
      var parts = value.split('; ' + name + '=');
      return parts.length === 2 ? parts.pop().split(';').shift() : '';
    }

    function buildMenuItems(btn) {
      var status = btn.getAttribute('data-status') || '';
      var requestId = btn.getAttribute('data-id') || '';
      var canApprove = isProcurement && (status === 'Pending' || status === 'Under Review');
      var items = [];
      if (canApprove) {
        items.push('<button class="action-menu-item action-approve" data-action="approve">Approve</button>');
        items.push('<button class="action-menu-item action-reject" data-action="reject">Reject</button>');
      } else {
        items.push('<button class="action-menu-item" data-action="view">View</button>');
      }
      return items.join('');
    }

    function showActionMenu(button) {
      currentActionButton = button;
      actionMenu.innerHTML = buildMenuItems(button);
      var rect = button.getBoundingClientRect();
      actionMenu.removeAttribute('hidden');
      actionMenu.setAttribute('aria-hidden', 'false');
      actionMenu.style.left = '-9999px';
      actionMenu.style.top = '-9999px';
      var menuWidth = actionMenu.offsetWidth || 160;
      var left = rect.right + window.scrollX - menuWidth;
      var top = rect.bottom + window.scrollY + 6;
      var minLeft = 8 + window.scrollX;
      if (left < minLeft) left = minLeft;
      actionMenu.style.left = left + 'px';
      actionMenu.style.top = top + 'px';
    }

    function hideActionMenu() {
      if (!actionMenu) return;
      actionMenu.setAttribute('hidden', '');
      actionMenu.setAttribute('aria-hidden', 'true');
      currentActionButton = null;
    }

    function doApprove(requestId) {
      fetch('/requests/' + requestId + '/approve-reject/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'approve' })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) { window.location.reload(); }
        else { alert('Error: ' + (data.error || 'Unknown error')); }
      })
      .catch(function(err) { alert('Error processing request'); console.error(err); });
    }

    function doReject(requestId) {
      var reason = prompt('Please enter the reason for rejection:');
      if (reason === null) return;
      reason = (reason || '').trim();
      if (!reason) { alert('Rejection reason is required.'); return; }
      fetch('/requests/' + requestId + '/approve-reject/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'reject', rejected_reason: reason })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) { window.location.reload(); }
        else { alert('Error: ' + (data.error || 'Unknown error')); }
      })
      .catch(function(err) { alert('Error processing request'); console.error(err); });
    }

    document.addEventListener('click', function (e) {
      var manageBtn = e.target.closest && e.target.closest('.action-btn');
      if (manageBtn) {
        e.preventDefault();
        e.stopPropagation();
        if (actionMenu && actionMenu.getAttribute('aria-hidden') === 'false' && currentActionButton === manageBtn) {
          hideActionMenu();
        } else {
          showActionMenu(manageBtn);
        }
        return;
      }
    }, true);

    document.addEventListener('click', function (e) {
      var menuItem = e.target.closest && e.target.closest('.action-menu-item');
      if (menuItem && currentActionButton) {
        e.preventDefault();
        var action = menuItem.getAttribute('data-action');
        var requestId = currentActionButton.getAttribute('data-id');
        hideActionMenu();
        if (action === 'approve') { doApprove(requestId); }
        else if (action === 'reject') { doReject(requestId); }
        else if (action === 'view') { window.location.href = '/requests/' + requestId + '/'; }
        return;
      }

      if (actionMenu && !e.target.closest('.action-menu')) {
        hideActionMenu();
      }
    });
  })();
</script>

<script>
  (function () {
    var selectAll = document.querySelector('.select-all');
    var table = document.querySelector('.inventory-table');
    if (!selectAll || !table) return;

    function updateSelectAllState() {
      var rowCheckboxes = table.querySelectorAll('tbody input.row-select');
      var total = rowCheckboxes.length;
      var checked = 0;
      rowCheckboxes.forEach(function (cb) { if (cb.checked) checked++; });
      if (checked === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checked === total) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    selectAll.addEventListener('change', function () {
      var checked = selectAll.checked;
      var rowCheckboxes = table.querySelectorAll('tbody input.row-select');
      rowCheckboxes.forEach(function (cb) { cb.checked = checked; });
    });

    table.addEventListener('change', function (e) {
      if (e.target && e.target.matches('input.row-select')) {
        updateSelectAllState();
      }
    });

    // initialize state
    updateSelectAllState();
  })();
</script>

<script>
  (function () {
    var tabButtons = document.querySelectorAll('.tab-btn');
    var table = document.querySelector('.inventory-table');
    if (!tabButtons.length || !table) return;

    // Server-provided counts for All, New, Pending (from json_script)
    var tabCountsEl = document.getElementById('tab-counts-data');
    var tabCountsFromServer = tabCountsEl ? JSON.parse(tabCountsEl.textContent) : {};

    // New = requested today or within last 2 days (data-new); Pending = status "Pending"
    var tabMap = {
      all: ['*'],
      new: 'data-new',   // special: show rows with data-new="true"
      pending: ['Pending'],
      'in-process': ['In Process', 'Approved', 'Out for Delivery'],
      delivered: ['Delivered'],
      completed: ['Completed'],
      rejected: ['Rejected']
    };

    function statusForRow(row) {
      var pill = row.querySelector('.col-status .status-pill');
      return pill ? pill.textContent.trim() : '';
    }

    function applyFilter(key) {
      var rule = tabMap[key];
      var rows = table.querySelectorAll('tbody tr.inventory-row');
      rows.forEach(function (row) {
        var show = false;
        if (key === 'all' || (rule && rule === '*')) {
          show = true;
        } else if (key === 'new' && rule === 'data-new') {
          show = row.getAttribute('data-new') === 'true';
        } else if (key === 'pending' && Array.isArray(rule)) {
          show = statusForRow(row) === 'Pending';
        } else if (Array.isArray(rule)) {
          var status = statusForRow(row);
          show = rule.indexOf(status) !== -1;
        }
        row.style.display = show ? '' : 'none';
      });
    }

    function updateBadges() {
      // All, New, Pending use server counts; others count from current page rows
      var rows = table.querySelectorAll('tbody tr.inventory-row');
      var counts = { 'all': 0, 'new': 0, 'pending': 0, 'in-process': 0, 'delivered': 0, 'completed': 0, 'rejected': 0 };
      var statusMap = {
        'in-process': ['In Process', 'Approved', 'Out for Delivery'],
        'delivered': ['Delivered'],
        'completed': ['Completed'],
        'rejected': ['Rejected']
      };
      rows.forEach(function (row) {
        if (row.getAttribute('data-new') === 'true') counts['new']++;
        var status = statusForRow(row);
        if (status === 'Pending') counts['pending']++;
        counts['all']++;
        Object.keys(statusMap).forEach(function (k) {
          if (statusMap[k].indexOf(status) !== -1) counts[k]++;
        });
      });
      tabButtons.forEach(function (btn) {
        var key = btn.getAttribute('data-key');
        var badge = btn.querySelector('.tab-badge');
        if (!badge) return;
        if (key === 'all' || key === 'new' || key === 'pending') {
          badge.textContent = tabCountsFromServer[key] !== undefined ? tabCountsFromServer[key] : counts[key];
        } else {
          badge.textContent = counts[key] || 0;
        }
      });
    }

    tabButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        tabButtons.forEach(function (b) { b.classList.remove('active'); });
        btn.classList.add('active');
        var key = btn.getAttribute('data-key');
        applyFilter(key);
      });
    });

    // Badges for All, New, Pending come from server (already in HTML); others from DOM
    updateBadges();
    applyFilter('all');
  })();
</script>

{% endblock %}


